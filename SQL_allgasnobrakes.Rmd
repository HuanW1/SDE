---
title: _`r paste0('COVID-19 Update ', format(Sys.Date(), '%B %d, %Y'))`_
output: 
  word_document:
    reference_docx: template.docx
params:
  desiredtime:
    label: "Desired Time"
    value: "8:30pm"
    input: text
---


```{r setup, include=FALSE}
###  CT DPH
###  Authors: Alexander Senetcky, Sydney Jones

#### knitr options ####
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(scipen = 999)

#### required packages are on L: ####
source("helpers/StartMeUp.R")
# require(rmarkdown)
# require(tidyverse)
# require(sf)
# require(odbc)
# require(kableExtra)
# require(lubridate)
# require(formatR)
# require(knitr)
# require(MMWRweek)
# require(scales)
# require(english)
# require(flextable)
# require(DBI)

#### kable options ####
options(kableExtra.auto_format = FALSE)

#### setting report dow options ####
# change for thanksgiving
graphdate <- Sys.Date() - 1
default_subtitle <- paste0("As of ", format(graphdate, "%m/%d/%Y"))

thursday <- wday(Sys.Date()) == 5
wedthurs <- wday(Sys.Date()) %in% c(5) # makes no sense this is the same as previous line
not_thursday <- wday(Sys.Date()) != 5

thursday_range_start <- floor_date(Sys.Date() - 12, unit = "week")
thursday_range_end <- thursday_range_start + 13
monthsame <- month(thursday_range_start) == month(thursday_range_end)

if (monthsame) {
  thursday_range <- paste0(
    month(thursday_range_start, label = TRUE, abbr = FALSE), " ",
    format(thursday_range_start, "%d"), '-',
    format(thursday_range_end, "%d")
  )
} else {
  thursday_range <- paste0(
    lubridate::month(thursday_range_start, label = TRUE, abbr = FALSE), " ",
    format(thursday_range_start, "%d"), '-', lubridate::month(thursday_range_end, label= TRUE, abbr = FALSE),
    " ",
    format(thursday_range_end, "%d")
  )
}

#### setting what we write out ####
csv_write <- TRUE
SQL_write <- TRUE

```

```{r declare_functions, include=FALSE}
df_to_table <- 
  function(df_name, 
           table_name = NULL,
           overwrite = FALSE, 
           append = TRUE) {
    
    ### error checking
    if(overwrite == append)  stop("You can not append and overwrite at the same time")
    if(missing(df_name)) stop("You must specify a dataframe")
    if(!exists(deparse(substitute(df_name))))  stop("Can not find that dataframe")
    if(is.null(table_name)) stop("You must specify a table in the database")
    
    ### main code
    epi_connect <- DBI::dbConnect(odbc::odbc(), "epicenter")
    
    # build the SQL string
    fqdbn <- paste0("DPH_COVID_IMPORT.dbo.", table_name)
    
    DBI::dbWriteTable(epi_connect, 
                      SQL(fqdbn), 
                      df_name, 
                      append = append, 
                      overwrite = overwrite)
    
    odbc::dbDisconnect(epi_connect)
  }

table_to_df <-
  function(table_name = NULL) {

    ### error checking
    if(is.null(table_name)) stop("You must specify a table in the database")
    sql_table_name <- SQL("DPH_COVID_IMPORT.dbo.report_summary")

    ### main code
    epi_connect <- DBI::dbConnect(odbc::odbc(), "epicenter")

    # build the SQL string
    fqdbn <- paste0("select * FROM [DPH_COVID_IMPORT].[dbo].[",
                    table_name,
                    "] ")

    results <- DBI::dbGetQuery(epi_connect,
                               statement = fqdbn)

    odbc::dbDisconnect(epi_connect)
    return(results)
  }

```

```{r test_pops_etc, include=FALSE}
#### list of PCR tests #### 
pcrtests <- c('SARS CoV 2 ORF1 resp', 
              'SARS CoV 2 RNA nasopharynx', 
              'SARS CoV 2 Rapid RdRp gene (AbbottIDNOW)',
              'COVID-19 RT-PCR INPATIENT/ED ADMIT',
              'COVID-19 RT-PCR OUTPATIENT (VACT)',
              'SARS CoV 2 RNA Saliva PCR',
              'SARS-CoV-2 PCR XXX', 
              'SARS CoV 2 PCR resp',
              'Other PCR',
              'SARS-CoV-2 RdRp gene resp',
              'SARS-CoV-2 RT-PCR-At Home Kits',
              'BHD COVID-19 RT-PCR NP',
              'RT-PCR',
              'SARS CoV 2 N resp',
              'SARS CoV 2 RNA (BioFire)',
              'SARS CoV 2 Rapid PCR Test RdRp gene result',
              'SARS-CoV-2 (COVID19) RNA [Presence] in Nose by NAA with probe detection',
              'SARS-CoV-2 (COVID-19) N gene [Cycle Threshold #] in Unspecified specimen by Nucleic acid amplification using CDC primer-probe set N1',
              'SARS-CoV-2 N gene Saliva',
              'COVID-19 PCR (CEPHEID)',
              'SARS CoV 2 NAA resp',
              'SARS-CoV-2 specific TCRB gene in Blood by Seq'
)

#### list of antigen tests ####
agtests <- c('SARS CoV 2 Ag rapid IA',
             'SARS-COV + SARS-CoV-2 Antigen resp',
             'SARS CoV 2 Ag (Quidel Sofia/Lumira)',
             'SARS CoV 2 Ag rapid IA (BD Veritor)',
             'SARS CoV 2 Ag rapid IA (BD Veritor/BinaxNOW)'
)

age_labels <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", ">=80")

# pop <- read_csv("L:/daily_reporting_figures_rdp/population_data/2018_dph_asrh/2018_asrh.csv") %>% 
#   select(age_g, total) %>% 
#   filter(!is.na(age_g))

epi_connect <- DBI::dbConnect(odbc::odbc(), "epicenter")
ghost_data <- tbl(epi_connect, sql("SELECT * FROM DPH_COVID_IMPORT.dbo.RPT_STATE_REA_DENOMS"))

pop <- 
  ghost_data %>% 
  select(year:pop) %>%
  filter(year == 2019) %>%
  collect() %>%
  mutate(age_g = cut(age,
                     breaks = c(-1,9,19,29,39,49,59,69,79, Inf),
                     labels = age_labels)) %>%
  group_by(age_g) %>%
  summarise(total = sum(pop))

odbc::dbDisconnect(epi_connect)

town_pop18 <- read_csv("L:/daily_reporting_figures_rdp/population_data/pop_towns2018.csv") %>% 
  rename(city = Town,
         pop = `Est. Pop.`)

#county city mapping
cc_map <- read_csv(
  paste0("L:/daily_reporting_figures_rdp/dependancies/City County Mapping.csv")) %>% 
  mutate(COUNTY = paste0(COUNTY," County"))
#county populations
county_pop <- read_csv("L:/daily_reporting_figures_rdp/population_data/county_pop.csv") %>% 
  mutate(County = paste0(County, " County"))

```

```{r read_cha, include=FALSE}

cha_file <- list.files("L:/daily_reporting_figures_rdp/CHA_data_here", pattern = ".csv", full.names = TRUE)
cha <-  read_csv(cha_file)
newcha <- cha %>% 
  filter(Type == "Admit" & State == "TOTAL") %>% 
  select(-c(Change, County, State)) %>% 
  pivot_longer(-Type, names_to = "admit_date", values_to = "admissions") %>% 
  select(-Type) %>% 
  mutate(admit_date = as.Date(admit_date, format = "%m/%d/%Y"))

```

```{r yesterday_summary, include=FALSE, eval=FALSE}
#### Check for yesterday data otherwise create fake ####
if(file.exists(paste0("L:/daily_reporting_figures_rdp/yesterday/", Sys.Date() - 1))) {
  yesterday_file <- list.files(paste0("L:/daily_reporting_figures_rdp/yesterday/", Sys.Date() - 1), 
                               pattern = ".csv")
} else {
  #  dir.create("yesterday") # it better exist
  dir.create(paste0("L:/daily_reporting_figures_rdp/yesterday/", Sys.Date() - 1))
  fake_yesterday <- tibble(
    'Overall Summary' = c(
      "COVID-19 Cases (confirmed and probable)", 
      "COVID-19 Tests Reported (molecular and antigen)", 
      "Daily Test Positivity*", 
      "Patients Currently Hospitalized with COVID-19", 
      "COVID-19-Associated Deaths"
    ),
    'Total**' = c('0','0','','0','0'),
    'Change Since Yesterday' = c('0','0','0%','0','0')
  )
  write_csv(fake_yesterday, path = paste0("yesterday/",Sys.Date() - 1, "/", Sys.Date() - 1,".csv" ))
  ## This is circular shouldn't it be yesterday_file <- fake_yesterday
  yesterday_file <- list.files(paste0("L:/daily_reporting_figures_rdp/yesterday/", Sys.Date() - 1), pattern = ".csv")
}

```


```{r shapefiles, include = FALSE}
#### towns shapes ####
if(file.exists("L:/daily_reporting_figures_rdp/shape_files/cb_2017_09_cousub_500k.shp")) {
  filename <- list.files('L:/daily_reporting_figures_rdp/shape_files', pattern=".shp", full.names=FALSE)
  filename <- gsub(".shp", "", filename)
  subdat <- sf::st_read('L:/daily_reporting_figures_rdp/shape_files', "cb_2017_09_cousub_500k")
  subdat <- sf::st_transform(subdat,"+init=epsg:4326")
}

#### counties shapes ####
filename<-list.files('L:/daily_reporting_figures_rdp/shape_files', pattern=".shp", full.names=FALSE)
filename<-gsub(".shp", "", filename)
subdat2 <- st_read('L:/daily_reporting_figures_rdp/shape_files',
                   "countyct_37800_0000_1990_s100_CENSUS_1_shp_wgs84")
subdat2 <- st_transform(subdat2,"+init=epsg:4326")
subdat3 <- subdat2

```



```{r SQL_pull_cleanup, include = FALSE, message= FALSE}
con2 <- DBI::dbConnect(odbc::odbc(), "epicenter")

# dbListFields(con2, SQL("DPH_COVID_IMPORT.dbo.CTEDSS_DAILY_REPORT_ALL_Cases"))
statement <-
  paste0("SELECT EVENT_ID as eventid, fname, lname, dob, phone,
          disease_status, age, gender, street, city, state,
          race, hisp, hospitalized, admit_date, discharge_date, icu,
          preg, symptoms, symp_onset_date, fever, fatigue, sob,
          chills, sorethroat, headache, cough, myalgia, new_olfact_taste,
          rigors, pneumonia, ards, outcome, death_date, diedwithcovid as covid_death,
          ocme_cov_rpt as ocme_reported, ocme_num as ocmeid, death_sfn as vrn,
          healthcare_worker, cong_setting,
          cong_exposure_type, cong_facility, cong_yn as ptreside, daycare_yn as daycare_attendee,
          daycare_occu as daycare_staff, case_create_date, case_mod_date, case_effective_date,
          case_eff_From_date as case_eff_from_date, event_date, facilityName,
          zip_code, race_concat
         FROM [DPH_COVID_IMPORT].[dbo].[CTEDSS_DAILY_REPORT_ALL_Cases]")


raw_cases <- DBI::dbGetQuery(conn = con2 , statement = statement)

statement <-
  paste0(
    "SELECT EVENT_ID as eventid,
      INVESTIGATION_CREATE_DATE as investigation_create_date,
      INVESTIGATION_MOD_DATE as investigation_mod_date,
      NEW_ELR_RESULT as new_elr_result,
      MRN_ELR as mrn_elr, TEST_NAME as test, RESULT as result,
      TESTED_DATE as tested_date, SPEC_COLL_DATE as spec_col_date,
      SPEC_REC_DATE as spec_rec_date, SPEC_NUM as spec_num,
      SPEC_SOURCE as source, AUTH_FACILITY as auth_facility,
      ORDERING_PROVIDER_NAME as ordering_provider_name,
      LAB_NAME as lab_name, FACILITY_NAME as facility_name,
      ORDERING_PROVIDER_FNAME as ordering_provider_fname,
      ORDERING_PROVIDER_LNAME as ordering_provider_lname,
      CASE_MODIFICATION_DATE as case_modification_date,
      result_rpt_date, Device_ID as device_id,
      SPEC_SOURCE_SNOMED as spec_source_snomed,
      RESULT_FREE_TEXT as result_free_text,
      ORDER_LAB_FACILITY as order_lab_facility,
      TESTING_LAB_CLIA as testing_lab_clia, NOTES2 as notes2
    FROM [DPH_COVID_IMPORT].[dbo].[DAILY_Reports_ALL_COVID_TESTS]"
  )

raw_tests <-  DBI::dbGetQuery(conn = con2 , statement = statement)

odbc::dbDisconnect(con2)

```


```{r df_creation}
df <-  left_join(raw_cases, raw_tests, by = c("eventid"))

rm(raw_cases)
rm(raw_tests)

df <-
  df %>%
  mutate(
    across(.cols = case_create_date:case_eff_from_date,
           ~ as_date(.x)),
    across(where(is.character), ~ na_if(.x, "NA")),
    ptreside = str_to_sentence(ptreside),
    gender = str_to_sentence(gender),
    death_date = mdy(death_date),
    event_date = mdy(event_date),
    spec_col_date = mdy(spec_col_date),
    outcome = str_to_sentence(outcome),
    fname = str_to_lower(fname),
    lname = str_to_lower(lname),
    dob = mdy(dob),
    disease_status = str_to_sentence(disease_status),
    age = floor(time_length(
      difftime(event_date, dob)
      ,unit = "years")
    ),
    cong_exposure_type = str_to_sentence(cong_exposure_type),
    cong_exposure_type = ifelse(
      is.na(cong_exposure_type) & ptreside == "Yes",
      "Reside",
      cong_exposure_type
    ),
    bigID = str_squish(paste0(fname, lname, dob)),
    result = str_to_lower(result),
    hospitalized = str_to_sentence(hospitalized),
    hospitalized = case_when(
      str_detect(hospitalized, "Yes") ~ "Yes",
      str_detect(hospitalized, "No")  ~ "No",
      is.na(hospitalized)             ~ "Unknown",
      TRUE                            ~ "Unknown"),
    source = str_to_lower(source),
    source = case_when(
      source %in% c("nasopharyngeal", "nasopharynx", "nasopharyngeal swab",
                    "np", "nasaopharyngeal", "naspharyngeal s", "nasopharngeal") ~ "np swab",
      source %in% c("nasal", "nasal aspirate/swab", "nasal swabs", "anterior nasal",
                    "nose", "anterior nares", "nose (nasal passage)",
                    "nares swab", "Nares swab-anterior nares swab",
                    "nasal swab taken", "nasal smear specimen",
                    "nares swab-anterior nares swab") ~ "nasal",
      source %in% c("serum", "cord blood", "d", "blood, whole", "venous blood") ~ "blood",
      source %in% c("saliva", "saliva swab", "oral swab", "oral  swab",
                    "oral fluid", "oral", "oral saliva sample") ~ "oral",
      source == "nasopharyngel and oropharyngeal swab" ~ "np and op swab",
      source %in% c("oropharyngeal/throat swab", "op swab", "opt") ~ "op swab",
      source %in% c("bronchial wash", "bronchoalveolar lavage (bal)",
                    "tracheal aspirate", "respiratory", "sputum",
                    "respiratory sample", "lung") ~ "resp",
      source == "other" ~ "unspecified specimen",
      is.na(source) ~ "unspecified specimen",
      TRUE ~ source),
    race = str_replace_all(race, "_", " "),
    race = str_to_title(race),
    hisp = str_to_sentence(hisp),
    city = str_to_title(city),
    race = case_when(
      race == "Black African American" ~ "Black",
      race == "Asian" | race == "Native Hawaiian Pacific Islander" ~ "Asian or Pacific Islander",
      race == "American Indian Alaskan Native" ~ "American Indian or Alaskan Native",
      TRUE ~ race
    ),
    hisp = if_else(
      hisp == "Yes",
      "H",
      "NH",
      "NH"  #na eth set to NH otherwise it breaks so many things
    ),
    race = case_when(
      is.na(race) | race =="Refused" ~ "Unknown",
      !race %in% c("White", "Black", "Asian", "American Indian or Alaskan Native",
                   "Asian or Pacific Islander", "Other", "Unknown") ~ "Multiracial",
      TRUE ~ race
    ),
    hisp_race = paste0(hisp, " ", race),
    hisp_race = ifelse(hisp == "H", "Hispanic", hisp_race),
    hisp_race = ifelse(hisp_race == "NH Unknown", "Unknown", hisp_race),
    age_group = cut(age,
                    breaks = c(-1,9,19,29,39,49,59,69,79, Inf),
                    labels = age_labels)
  )

df <- df %>% 
  left_join(cc_map %>% rename(county=COUNTY), by = c("city" = "CITY"))

```



```{r multi_and_beyond}

#### multioutcome ####

df <-
  df %>%
  group_by(bigID) %>%
  mutate(outcome = ifelse(any(outcome == "Died"),
                           "Died",
                           outcome)) %>%
  ungroup()

##########  Death Cleanup     #############

df$outcome[df$covid_death == "No"] <- NA
#df$death_date[df$covid_death == "No"] <- NA

test_people <- df %>% 
  filter(
    str_detect(str_to_lower(fname), "import|zztest|\\bzzz\\b|covid|validation|schedule|[0-9][^nsrt]|identif|\\btest\\b|sqtwo|sqthree|mytest")|str_detect(str_to_lower(lname), "zztest|\\bzzz\\b|covid|validation|schedule|[0-9][^nsrt]|identif|\\btest\\b|ascaris")
  ) %>% 
  select(eventid) %>% 
  distinct() %>%
  pull(eventid)


df <- df %>% 
  filter(!eventid %in% test_people)

#####test results cleaning
df$result <- ifelse(
  str_detect(df$result, "not ?(un)?detected|negative"),
      "not detected",
  ifelse(
    str_detect(df$result,"(?<!not|un|not) ?detected|posi?ti?ve"),
  "detected",
  "indeterminate"
  )
)

###bad spec_col_dates blanked out
# df$spec_col_date[df$spec_col_date < ymd("2020-02-20")] <- NA
# df$spec_col_date[df$spec_col_date > Sys.Date()] <- NA

df <-
  df %>%
  mutate(spec_col_date = if_else(spec_col_date < ymd("2020-02-20") | spec_col_date > Sys.Date(),
                                 NA_Date_,
                                 spec_col_date,
                                 missing = NA_Date_))


#setting confirmed with no +pcr or blank pcr results to suspect at the top here and then the rest of the checks will pop them in their proper category should they be picked up again

#leave folks who are covid_death = Yes and their disease status %in% Confirmed, Probable alone, except probables should be able to be upped to conf if applicable
untouchable_conf <- df %>%  
  filter(outcome == "Died" & disease_status == "Confirmed") %>% 
  select(eventid) %>% 
  distinct()

#suspect who should be probable based on ocmeid and covid_death = yes
ocmeprob <- df %>% 
  filter(disease_status == "Suspect" & !is.na(ocmeid) & covid_death == "YES") %>% 
  select(eventid) %>% 
  distinct()

#currently not much going on with this object here, but maybe down the line
mostly_untouchable_prob <- df %>%  
  filter(outcome == "Died" & disease_status == "Probable") %>% 
  select(eventid) %>% 
  distinct()

conf_good_result <- df %>% 
  filter(
    test %in% pcrtests &
      disease_status == "Confirmed" &
      result %in% c('detected')
        ) %>%  
      select(eventid) %>%  
      distinct()

conf_bad_result <- df %>% 
  filter(
    test %in% pcrtests &
      disease_status == "Confirmed" &
      result %in% c(NA, 'not detected', 'indeterminate')
      ) %>%  
  select(eventid) %>%  
  distinct()

conf_bad_result <- df %>% 
  filter(eventid %in% conf_bad_result$eventid & !eventid %in% conf_good_result$eventid & !eventid %in% untouchable_conf$eventid & !eventid %in% mostly_untouchable_prob$eventid) %>% #the last filter portion with the probs doesn't change anything for now becuase this has to do with confirmeds, but i thoought it wouldnt hurt
  select(eventid, disease_status, test, result, spec_col_date, symp_onset_date) %>% 
  arrange(eventid)

df$disease_status[df$eventid %in% conf_bad_result$eventid] <- "Suspect" #conf to suspect

pcr_not_confirmed <- df %>%
  filter(state == "CT"| is.na(state)) %>%
  filter(test %in% pcrtests & !disease_status %in% c("Confirmed", "Not a case") & result == "detected") %>%  
  select(eventid) %>% 
  distinct()

pcr_confirmed <- df %>%
  filter(state == "CT"| is.na(state)) %>%
  filter(test %in% pcrtests & result == "detected") %>%  
  select(eventid) %>% 
  distinct()

ag_probable <- df %>%
  filter(!eventid %in% pcr_confirmed$eventid) %>% 
  filter(state == "CT"| is.na(state)) %>%
  filter(test %in% agtests & !disease_status %in% c("Probable") & result == "detected") %>%  
  select(eventid) %>% 
  distinct()

df_suspect <- df %>% 
  filter(disease_status == "Suspect") %>% 
  filter(state == "CT"| is.na(state)) 
  
two_or_more_symps <- df_suspect %>% 
  select(eventid, disease_status, fever, chills, rigors, myalgia, headache, sorethroat, new_olfact_taste) %>% 
  pivot_longer(-c(eventid, disease_status), names_to = "symptom", values_to = "symp_pres") %>% 
  filter(symp_pres == "Yes") %>% 
  group_by(eventid, disease_status) %>% 
  tally() %>% 
  filter(!disease_status %in% c("Confirmed", "Probable")  & n >= 2) %>% 
  select(eventid) %>% 
  distinct()

one_of_symps <- df_suspect %>%   
  select(eventid, disease_status, cough, sob, ards, pneumonia) %>% 
  pivot_longer(-c(eventid, disease_status), names_to = "symptom", values_to = "symp_pres") %>% 
  filter(symp_pres == "Yes") %>% 
  group_by(eventid, disease_status) %>% 
  tally() %>% 
  filter(!disease_status %in% c("Confirmed", "Probable")) %>% 
  select(eventid) %>% 
  distinct()

suspect_probable <- df_suspect %>% 
  filter((eventid %in% one_of_symps$eventid|eventid %in% two_or_more_symps$eventid)) %>% 
  unique() 

df <- df %>%
  mutate(disease_status = ifelse(eventid %in% ocmeprob$eventid, "Probable", disease_status)) %>%  #ocmeid + covid_death = yes, setting disease status to probable
  mutate(disease_status = ifelse(eventid %in% pcr_not_confirmed$eventid,  "Confirmed", disease_status)) %>% #PCR postives not already confirmed  changed to Confirmed
  mutate(disease_status = ifelse(eventid %in% ag_probable$eventid,  "Probable", disease_status)) %>%  #AG postives not already probable changed to Probable
  mutate(disease_status = ifelse(eventid %in% suspect_probable$eventid, "Probable", disease_status))

rm(df_suspect)

```


```{r case_creation1}
######case pt 1############
case <- df %>% 
  filter(disease_status == "Confirmed"  | disease_status == "Probable") %>%
  filter(state == "CT" | is.na(state)) %>% 
  mutate(
    date = case_when(
      disease_status %in% c("Confirmed", "Probable") & !is.na(spec_col_date) ~ spec_col_date,
      disease_status %in% c("Confirmed", "Probable") & is.na(spec_col_date) ~ event_date,
      TRUE ~ NA_Date_
    )) %>%
  filter(date > ymd("2020-03-01") & 
           date <= today()) %>% 
  mutate(
    week = epiweek(date), 
    year = epiyear(date),
    mmwrweek = epiweek(date), #setting to date so it works for now
    simple_result = ifelse( 
      result == "detected",
      1,2
    ),
    pcrtest = ifelse(test %in% pcrtests, 1, 2)
  ) %>%
  mutate(cong_yn = if_else(
    cong_exposure_type ==  "Reside" &
      (cong_setting== "JAIL" | cong_setting == "LTCF"| cong_setting == "ALF" ),
    "Yes", "No", missing = "No")) %>% 
  group_by(bigID) %>%
  arrange(simple_result,pcrtest,date) %>% # detected, first priority, and then the pcr test or ag if no pcr, then earliest date, date is spec_col_Date for tests with that or eventdate if none listed or is a non ag+ prob
  slice(1L) %>%
  ungroup() 

#Outcome and Covid Death Cleanup
#case$covid_death[case$eventid %in% untouchable_conf$eventid] <- "YES"  pulls in too many wrong.
case$covid_death[is.na(case$outcome) & case$covid_death == "NO" | case$covid_death == "UNKNOWN"] <- NA
case$outcome[case$covid_death == "NO" | is.na(case$covid_death)] <- NA
case$outcome[case$outcome == "Unknown"] <- NA
case$outcome[case$covid_death == "YES"] <- "Died"
case$death_date[is.na(case$covid_death) | case$covid_death == "NO"] <- NA

thursday_case <- case %>% 
  filter(date >= thursday_range_start & date <= thursday_range_end )

#count(case, hisp_race2)
# case2 <- case %>% 
#   select(-phone) %>% 
#   select(eventid,disease_status, age, gender, city, county, state, hisp_race, race, hisp,hospitalized, admit_date, discharge_date, icu, preg, symptoms, symp_onset_date, spec_col_date, fever, fatigue, sob, headache, cough, myalgia, new_olfact_taste, rigors, pneumonia, ards, outcome, death_date, healthcare_worker, cong_setting, cong_exposure_type, cong_facility, cong_yn, case_create_date, event_date, mmwrweek)
# 
# if (csv_write) {
#   dir.create(paste0("L:/daily_reporting_figures_rdp/csv/", Sys.Date()))
#   write_csv(case2, 
#             paste0("L:/daily_reporting_figures_rdp/csv/", Sys.Date(), 
#                    "/", Sys.Date(), "cases.csv"))
# }
# 
# rm(case2)
# 
# if (SQL_write) {
#   #  df_to_table()
# }


case3 <- case %>% 
select(eventid,fname, lname, dob, phone, disease_status, age, gender, street, city, county, state, hisp_race, race, hisp,hospitalized, admit_date, discharge_date, icu, preg, symptoms, symp_onset_date, spec_col_date, fever, fatigue, sob, headache, cough, myalgia, new_olfact_taste, rigors, pneumonia, ards, outcome, covid_death, vrn, ocme_reported, ocmeid, death_date, healthcare_worker, cong_setting, cong_exposure_type, cong_facility,cong_yn, case_create_date, event_date, test, result, lab_name, mmwrweek)

if(csv_write){
  write_csv(case3, paste0("L:/daily_reporting_figures_rdp/csv/",
                          Sys.Date(),"/", Sys.Date(), "cases_wphi.csv"))
}

rm(case3)

case <- case %>% select(-phone)

# cdc_numbers <- case %>% 
#   group_by(disease_status) %>% 
#   tally(name = "Cases") %>% 
#   left_join(
#     case %>% 
#       filter(outcome == "Died") %>% 
#       group_by(disease_status) %>% 
#       tally(name = "Deaths"),
#     by = c('disease_status' = 'disease_status')
#   )
# 
# if(csv_write) {
#   write_csv(cdc_numbers, 
#             paste0("L:/daily_reporting_figures_rdp/csv/", 
#                                 Sys.Date(), "/",  Sys.Date(), "cdc_numbers.csv")) #who actually uses this?
# }

```

```{r pending_validation, message=FALSE, warning=FALSE, include=FALSE}
pendingaddress_text <- case %>% 
  filter(is.na(county) & disease_status %in% c("Confirmed", "Probable")) %>% 
 group_by(county) %>% 
  tally() %>% 
  select(n)

thursday_pending_address <- thursday_case %>% 
  filter(is.na(county) & disease_status %in% c("Confirmed", "Probable")) %>% 
 group_by(county) %>% 
  tally() %>% 
  select(n)

```


```{r lab_misc, include= FALSE}
outstatecolleges <- c(
"Afc Bryn Mawr College",
"American University Student",
"American Unviersity Student Health Center",
"Amherst College",
"Anna Maria College",
"Arcadia University",
"Assumption University",
"Babson College",
"Bank Street College",
"Bard College At Simon's Rock",
"Barnard College",
"Bay Path University",
"Bentley University",
"Boston College",
"Brandeis University",
"Brandeis University Admissions",
"Brandeis University Heller",
"Bridgewater State University",
"Bryant University",
"Campbell University Health",
"Cc-University of San Diego",
"Champlain College",
"Chapman University",
"Clark University",
"Clark University Bts",
"Clarkson University",
"Coastal Carolina University",
"Colby College",
"College of the Atlantic",
"College of the Holy Cross",
"Columbia Univ Hlth Svcs",
"Columbia University",
"Columbia University- Medical",
"Columbia University MC I/F",
"Crh/emory University",
"Curry College",
"Curry Colllege",
"Drexel University Student Hlth",
"Duke University Screening",
"Duquesne University-Student",
"Elms College",
"Elon University",
"Embry Riddle Aeronautical Univ",
"Emerson College",
"Fisher College",
"Fitchburg State University",
"Fl Gulf Coast University",
"Fordham Bronx Employees",
"Fordham Bronx Students",
"Fordham University",
"Framingham State University",
"Frostburg State Univ",
"George Mason University",
"Gordon College Medical center",
"Hamilton College",
"Hampshire College",
"Health Ctr Landmark College",
"High Point University Student",
"Hobart And William Smith Colleges",
"Hoboken University Medical Ctr",
"Husson University",
"Interlochen Arts Academy",
"James Madison University",
"Johnson And Wales University",
"Keene State-Bts",
"La Salle University",
"Lasell University",
"Liberty Univ Student Health Ctr",
"Lincoln Center Employees",
"Lincoln Center Students",
"Manhattan College Health Services",
"Manhattanville College",
"Massachusetts College of Art And Design",
"Massachusetts College of Liberal Arts",
"Massachusetts Institute of Technology",
"Massbio - Mattapan",
"McDaniel College",
"McPhs-Boston",
"McPhs-Manchester",
"McPhs-Worcester",
"Medexpress - State College",
"Medical Univ of South Carolina",
"Merrimack College",
"Messiah College Health Center",
"Middlebury College",
"Mount Holyoke College",
"Mount Saint Mary College",
"Nichols College",
"Northeastern University Health And Counseling Services",
"Northwestern Univ Hlth Serv",
"Norwich University",
"Notre Dame At Home",
"Nys - Niagra County Community College",
"Nys - Rochester Monroe Community College",
"Providence College",
"Psu-Covid University Park",
"Reed College Health and Counseling Center",
"Regis College",
"Rhode Island School of Design",
"Roger Williams University",
"Rwu Providence Campus",
"Salem State Staff",
"Salem State University",
"Seton Hill University",
"Simmons University",
"Smith College",
"Springfield College",
"St Olaf College",
"St Louis University",
"St. Thomas More",
"Stonehill College",
"Stony Brook University Student Health Center",
"Suffolk University",
"Suffolk University Sargent",
"Suffolk University Sawyer",
"Suny Maritime College",
"Swathmore College",
"Syracuse Univ Hlth Srvc",
"the Catholic Univ of America",
"the University of Vermont Medical Center",
"Temple Univ Health Services",
"Tuftsuemp (Marathon Health)",
"Tuftsugst (Oehn-Provider1)",
"Tuftsumst (Student Health Services)",
"Tuftsuvnd (Oehn-Provider2)",
"Umass Memorial",
"Umass University Campus",
"Umass University Health",
"University of Lynchburg",
"University of Maryland",
"University of Massachusetts Amherst",
"University of Massachusetts Amherst Springfield Center",
"University of Massachusetts Boston",
"University of Massachusetts Dartmouth",
"University of Massachusetts Medical School",
"University of Michigan Health System",
"University of Missouri-Department of Pathology",
"University of Rhode Island",
"University of Scranton",
"University of Tampa",
"University of Vermont",
"Villanova University",
"Villanova University Shc",
"Wake Forest University Student Health Services",
"Wagner College",
"Washington College Hlth Serv",
"Wellesley College",
"Westfield State University",
"Wheaton College",
"Williams College",
"Worcester Polytechnic Institute",
"Worcester State University"
)

outstate<-filter(df, auth_facility %in% outstatecolleges)

elr <-   df %>% 
  rename(
    test_method = test,
    lab_result_create_date = investigation_create_date,
    lab_result_mod_date = investigation_mod_date,
    #ordering_lab = `Ordering Lab Facility`, this missing?
    lab_facility = facility_name,
    #name = lab_name,
    spec_rec_date = spec_rec_date,
    date_tested = tested_date,
    date_reported_dph = result_rpt_date,
    ) %>%
  filter(!is.na(test_method)) %>% # filter our blank tests (captured later on in the in statements but cant hurt to have less data now)
  filter(!is.na(result)) %>% # filter out blank results
  filter(!auth_facility %in% outstatecolleges) %>% 
  select(-c( admit_date, ards, chills,  cong_exposure_type, cong_facility, cong_setting, cough, covid_death, death_date, discharge_date, fatigue, fever, headache, healthcare_worker, hisp, hospitalized, icu, myalgia, new_olfact_taste, outcome,  preg, race, sob, sorethroat, rigors)) %>% 
 filter(state == "CT" | is.na(state)) %>%  #keep ct or blank state
   filter(test_method %in% pcrtests| test_method %in% agtests) %>%  #keep only test methods we care about
  mutate( #new test var to distinct upon
    pcrag  = ifelse(test_method %in% pcrtests,
                    "pcr",
                    "ag"
                    )
  ) %>%  
  distinct(
    eventid, pcrag, spec_col_date, result, spec_num, .keep_all = TRUE
  ) %>% 
   distinct(
    eventid, pcrag, spec_col_date, result, source, .keep_all = TRUE
  ) %>% 
  distinct(
     pcrag, fname, lname,  dob, spec_col_date, spec_num, result, .keep_all = TRUE
  ) %>%
  distinct(
     pcrag, fname, lname, dob, spec_col_date, source, result, .keep_all = TRUE
  ) #%>% 
  #rename(zipcode = 'Postal Code')

elr_linelist <- elr
elr_linelist_elronly <-  elr_linelist %>% 
  filter(new_elr_result == "YES") #%>%
  # mutate(result = ifelse(
  #     result %in% c("not detected", "indeterminate"),
  #     "Not Positive", "Positive" ) )
number_of_elr <- elr_linelist_elronly %>% 
  filter(test_method %in% pcrtests) %>% 
  nrow()
  
total_pcr_tests <- nrow(elr %>%  filter(test_method %in% pcrtests))  # change to PCR only and change name
total_ag_tests <- nrow(elr %>%  filter(test_method %in% agtests))

elr <- elr %>%
  group_by(spec_col_date, result) %>%
  tally()
missing_spec_date <- sum(elr$n[is.na(elr$spec_col_date)])
pos_tests <- sum(elr$n[elr$result == "detected"])
neg_tests <- sum(elr$n[elr$result == "not detected"])
total_tests_thursday <- elr %>% filter(spec_col_date >= thursday_range_start & spec_col_date <= thursday_range_end) %>% mutate(j=1) %>%  group_by(j) %>%  summarize(n = sum(n)) %>% select(n) 
total_tests_thursday <-total_tests_thursday$n
pos_tests_thursday <- elr %>% filter(result == "detected" & spec_col_date >= thursday_range_start & spec_col_date <= thursday_range_end) %>% group_by(result) %>%  summarize(n = sum(n)) %>% select(n)
pos_tests_thursday <- pos_tests_thursday$n
neg_tests_thursday <- elr %>% filter(result == "not detected" & spec_col_date >= thursday_range_start & spec_col_date <= thursday_range_end) %>% group_by(result) %>%  summarize(n = sum(n)) %>% select(n)
neg_tests_thursday <- neg_tests_thursday$n

# write_csv(elr_linelist, 
#           paste0("L:/daily_reporting_figures_rdp/elr_linelists/elr_linelist", 
#                  Sys.Date(), 
#                  ".csv")
#           )

if(csv_write) {
  data.table::fwrite(elr_linelist, 
                     paste0("L:/daily_reporting_figures_rdp/elr_linelists/elr_linelist", 
                            Sys.Date(), 
                            ".csv"), 
                     buffMB = 16, 
                     nThread = 4, 
                     verbose = FALSE, 
                     showProgress = FALSE)
}
rm(df)

```


```{r geos}
cha_c <- cha %>%
  filter(Type == "Admit") %>% 
  select(-Type) %>% 
  rename(NAME=County )
cols <- ncol(cha_c)
cha_c <- cha_c %>% 
  rename( today= cols-1,
          yesterday = cols-2) %>% 
  mutate(sign = ifelse(
    Change>=0,
    "+",
    "-"
    ),
    Change = abs(Change)
  )
num_groups <- c("None", "1 to 5", "6 to 10", "11 to 25", "26 to 50", "51 to 100", "101 to 200", "201 to 500", "501 to 1000", "1001 to 5000")
cha_c <- cha_c %>% 
  mutate(
    ngrp = cut(today, breaks = c(-Inf,0,5,10,25,50,100,200,500,1000, Inf), labels = num_groups )
  )
subdat2 <- subdat2 %>%
  left_join(
    cha_c, by = c("NAME" = "NAME")    
  )
case_m <- case %>%
  mutate(NAME = str_to_title(city)) %>% 
  group_by(NAME) %>% 
  tally() %>% 
  complete(NAME = unique(town_pop18$city), fill = list(n = 0))
case_m$n[is.na(case_m$n)] <- 0
num_groups <- c("0 to 5", "6 to 50", "51 to 100", "101 to 200", "201 to 500", "501 to 1000", "1001 to 5000", ">5000")
case_m <- case_m %>% 
  mutate(
    n = cut(n, breaks = c(-Inf,5,50,100,200,500,1000, 5000, Inf), labels = num_groups )
          )
subdat <- subdat %>% 
  left_join(
    case_m, by = c("NAME" = "NAME")    
  )
subdat$n[is.na(subdat$n)] <- "None"
subdat <- subdat %>% 
  mutate(
    n=factor(n, levels = num_groups, labels = num_groups)
  )
num_groups2 <- c("None", "1 to 5", "6 to 50", "51 to 100", "101 to 200", "201 to 500", "501 to 1000", "1001 to 5000", "5001 to 10000", "10001 to 25000", "Greater than 25000")
cuml_cols <- ncol(cha)-2
cha_cuml <- cha %>% 
  filter(Type == 'CumAdmit')
cha_cuml <- cha_cuml[c(1:3,cuml_cols)] %>% 
  replace_na(replace = list(County = "TOTAL")) 
names(cha_cuml)[length(names(cha_cuml))] <- "yesterday"
cha_cuml <- cha_cuml%>% 
  mutate(
    cmlgrp = cut(yesterday, breaks = c(-Inf,0,5,50,100,200,500,1000, 5000, 10000, 25000, Inf), labels = num_groups2)
      )
subdat3 <- subdat3 %>% 
  left_join(
    cha_cuml, by =c("NAME" = "County")
  )


```


```{r intro_text}
today_text <- format(graphdate, "%B %d, %Y")
cases_text <- nrow(case)  # for now
confirmed_text <- nrow(case %>%  filter(disease_status == "Confirmed"))
probable_text <- nrow(case %>% filter(disease_status == "Probable"))
hosp_text <- str_to_sentence(as.english(cha_c$today[cha_c$State =='TOTAL']))  # for now
dec <- case %>% filter(outcome == 'Died') %>% nrow()
deaths_text <- str_to_sentence(as.english(dec))  # for now
```

As of **`r today_text`**, the total of laboratory-confirmed and probable COVID-19 cases reported among Connecticut residents is **`r cases_text`**, including **`r confirmed_text`** laboratory-confirmed and **`r probable_text`** probable cases.  **`r hosp_text `** patients are currently hospitalized with laboratory-confirmed COVID-19. There have been **`r dec`** COVID-19-associated deaths.  

```{r gary_text, message=FALSE, warning=FALSE, include=FALSE, eval= FALSE}
saveto <- paste0("L:/daily_reporting_figures_rdp/gary_text/", Sys.Date()) #### ?
dir.create(saveto)
rmarkdown::render("gary_text.Rmd", output_file = paste0(saveto,"/", Sys.Date(), "text.html"))

```

```{r new_overall_summary_table, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

hospitalized_totals <-  cha_c %>%  filter(State== "TOTAL") %>% select(today)

# discharged_totals <- cha %>%
#   filter(Type == "Discharge") %>%
#   select(-Type)
# cols2 <- ncol(discharged_totals)
# discharged_totals <- discharged_totals %>%
#   rename( today= cols2-1,
#           yesterday = cols2-2) %>%
#   filter(State== "TOTAL") %>%
#   select(today)

ncases <- nrow(case)
ntests <- nrow(elr_linelist)

mock_table <-
  tibble(`Overall Summary` = c("COVID-19 Cases (confirmed and probable)",
                               "COVID-19 Tests Reported (molecular and antigen)",
                               "Daily Test Positivity*",
                               "Patients Currently Hospitalized with COVID-19",
                               "COVID-19-Associated Deaths"),
         `Total**` = c("", "", "", "", ""),
         `Change Since Yesterday` = c("", "", "", "", ""))

tbl_total_col <-
  c(as.character(ncases),
    as.character(ntests),
    "",
    as.character(hospitalized_totals$today),
    as.character(dec))

mock_table$`Total**` <- tbl_total_col

### Temporary logic to get last report
when_was_last_report <-
  case_when(weekdays(today()) %in% c("Monday", "Sunday") ~ "Friday",
            TRUE ~ weekdays(today() - 1))

last_rpt_data <-
  table_to_df("RPT_summary_bydate") %>%
  filter(dow_report_date == when_was_last_report) %>%
  filter(report_date == max(report_date))

Positivity <- (ncases - last_rpt_data$Cases)/(ntests - last_rpt_data$Tests)

yesterday_col <-
  c(
    paste0("+", ncases - last_rpt_data$Cases),
    paste0("+", ntests - last_rpt_data$Tests),
    paste0(round(Positivity * 100, 2), "%"),
    ifelse(hospitalized_totals$today - last_rpt_data$Hospitalized > 0,
           paste0("+", hospitalized_totals$today - last_rpt_data$Hospitalized),
           paste0(hospitalized_totals$today - last_rpt_data$Hospitalized)),
    ifelse(dec - last_rpt_data$Deaths > 0,
           paste0("+", dec - last_rpt_data$Deaths),
           paste0(dec - last_rpt_data$Deaths))
  )

mock_table$`Change Since Yesterday` <- yesterday_col

tableforgary <- mock_table

write_csv(mock_table,
          "L:/yesterday_test.csv")

if(csv_write) {
  dir.create(paste0('L:/daily_reporting_figures_rdp/yesterday/', Sys.Date()))
  write_csv(mock_table, 
            paste0("L:/daily_reporting_figures_rdp/yesterday/", 
                   Sys.Date(), "/", Sys.Date(), ".csv"))
}

mock_table <-
  regulartable(mock_table) %>%
  flextable::autofit()
mock_table <- align_nottext_col(mock_table,
                                align = "center")

mock_table

values_formatted <-
  paste0("'",
         paste(today(),
               weekdays(today()),
               ncases,
               ntests,
               Positivity,
               hospitalized_totals$today,
               dec,
               sep = "', '"),
         "'")


statement <-
  paste0("IF EXISTS (SELECT * FROM [DPH_COVID_IMPORT].[dbo].[RPT_summary_bydate]
            WHERE report_date = '", today(), "')
            UPDATE [DPH_COVID_IMPORT].[dbo].[RPT_summary_bydate]
            SET report_date ='", today(), "', dow_report_date = '", weekdays(today()),
         "', Cases = '", ncases, "', Tests = '", ntests,
         "', Positivity = '", Positivity, "', Hospitalized = '", hospitalized_totals$today,
         "', Deaths = '", dec,
         "' WHERE report_date = '", today(), "'
          ELSE
            INSERT INTO [DPH_COVID_IMPORT].[dbo].[RPT_summary_bydate]
            VALUES (", values_formatted, ")")

con2 <- DBI::dbConnect(odbc::odbc(), "epicenter")

invisible(capture.output(
  dbExecute(
    con2,
    statement
  )))

odbc::dbDisconnect(con2)



```

```{r overall_summary_table, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
if(exists('fake_yesterday')){
hospitalized_totals <-  cha_c %>%  filter(State== "TOTAL") %>% select(today)
discharged_totals <- cha %>%
  filter(Type == "Discharge") %>%
  select(-Type)
cols2 <- ncol(discharged_totals)
discharged_totals <- discharged_totals %>%
  rename( today= cols2-1,
          yesterday = cols2-2) %>%
  filter(State== "TOTAL") %>%
  select(today)
tbl_summary <- tibble(
  'Overall Summary' = c(
    "COVID-19 Cases (confirmed and probable)", 
    "COVID-19 Tests Reported (molecular and antigen)", 
    "Daily Test Positivity*", 
    "Patients Currently Hospitalized with COVID-19", 
    "COVID-19-Associated Deaths"
      )
    )

ncases <- nrow(case)
ntests <- nrow(elr_linelist)

tbl_total <-  tibble( 
  "Total**" = c(
    ncases,
    ntests,
    round(ncases/ntests*100,2),
    hospitalized_totals,
    dec
    )
  )
tbl_total$`Total**` <- as.character(tbl_total$`Total**`)
tbl_total[3,] <- ""

chg_yst <- tibble("Change Since Yesterday" = c('+0','+0','0%','+0', '+0'))
ovlsum <- bind_cols(tbl_summary, tbl_total, chg_yst)

tableforgary <- ovlsum

if(csv_write) {
  dir.create(paste0('L:/daily_reporting_figures_rdp/yesterday/', Sys.Date()))
  write_csv(ovlsum, 
            paste0("L:/daily_reporting_figures_rdp/yesterday/", 
                           Sys.Date(), "/", Sys.Date(), ".csv"))
  # testing new code Feb 1
}

df_to_table(ovlsum, "test_overall_summary", overwrite = TRUE, append = FALSE)

ovlsum <- regulartable(ovlsum) %>%
  flextable::autofit()
ovlsum <- align_nottext_col(ovlsum,align = "center")
ovlsum

} else{
hospitalized_totals <-  cha_c %>%  filter(State== "TOTAL") %>% select(today)
discharged_totals <- cha %>%
  filter(Type == "Discharge") %>%
  select(-Type)
cols2 <- ncol(discharged_totals)
discharged_totals <- discharged_totals %>%
  rename( today= cols2-1,
          yesterday = cols2-2) %>%
  filter(State== "TOTAL") %>%
  select(today)

tbl_summary <- tibble(
  'Overall Summary' = c(
    "COVID-19 Cases (confirmed and probable)", 
    "COVID-19 Tests Reported (molecular and antigen)", 
    "Daily Test Positivity*", 
    "Patients Currently Hospitalized with COVID-19", 
    "COVID-19-Associated Deaths"
      )
    )

ncases <- nrow(case)
ntests <- nrow(elr_linelist)

tbl_total <-  tibble( 
  "Total**" = c(
    ncases,
    ntests,
    0,#round(ncases/ntests*100,2),
    hospitalized_totals,
    dec
    )
  )
tbl_total$`Total**` <- as.double(tbl_total$`Total**`)

chg_yst <- read_csv(paste0("L:/daily_reporting_figures_rdp/yesterday/",Sys.Date() - 1, "/", yesterday_file)) %>%
  select(`Total**`) %>%
  rename(yesterday = `Total**`) %>%
  bind_cols(tbl_total) %>%
  mutate(
    `Total**` =as.double(`Total**`),
    sign = ifelse(`Total**`>= yesterday, "+", "-"),
    delta = abs(`Total**` - yesterday),
    'Change Since Yesterday' = paste0(sign, delta)
         ) %>%
  select('Change Since Yesterday')
chg_yst[3,] <- paste0(round(as.double(chg_yst[1,])/as.double(chg_yst[2,])*100,2), "%")



tbl_total$`Total**` <- as.character(tbl_total$`Total**`)
tbl_total[3,] <- ""
ovlsum <- bind_cols(tbl_summary, tbl_total, chg_yst)
tableforgary <- ovlsum
cha_stats <-  bind_cols(tbl_summary, tbl_total) %>%
  rename(summary = `Overall Summary`, total = `Total**`)

if(csv_write) {
  dir.create(paste0('L:/daily_reporting_figures_rdp/yesterday/', Sys.Date()))
  write_csv(ovlsum, 
            paste0("L:/daily_reporting_figures_rdp/yesterday/", 
                   Sys.Date(), "/", Sys.Date(), ".csv"))
}

ovlsum <- regulartable(ovlsum) %>%
  flextable::autofit()
ovlsum <- align_nottext_col(ovlsum,align = "center")
ovlsum
}

```
\*\*Includes confirmed plus probable cases  

**COVID-19 Cases and Associated Deaths by County of Residence**  
*As of `r paste0(format(graphdate, "%m/%d/%y"))`.*
```{r county_lab_cases_deaths_table, message=FALSE, warning=FALSE}
tbl_county <- tibble::tibble(County = forcats::as_factor(c("Fairfield County", "Hartford County", "Litchfield County", "Middlesex County", "New Haven County", "New London County", "Tolland County", "Windham County", "Pending address validation")))
tbl_confirmed_cases <- case %>%
  filter(disease_status == "Confirmed") %>% 
  group_by(county) %>% 
  tally() %>% 
  replace_na(replace = list(county= "Pending address validation")) 
tbl_probable_cases <- case %>%
  filter(disease_status == "Probable") %>% 
  group_by(county) %>% 
  tally() %>% 
  replace_na(replace = list(county= "Pending address validation"))
tbl_confirmed_dec <-  case %>%
  select(county, outcome, disease_status) %>% 
  filter(outcome == "Died" & disease_status == "Confirmed")%>% 
  group_by(county) %>% 
  tally() %>% 
  replace_na(replace = list(county = "Pending address validation")) %>% 
  complete(county = tbl_county$County, fill = list(n = 0))
tbl_confirmed_dec$county <- factor(tbl_confirmed_dec$county ,level = tbl_county$County, labels = tbl_county$County)
tbl_confirmed_dec <- tbl_confirmed_dec %>% arrange(county)
tbl_prob_dec <-  case %>%
  select(county, outcome, disease_status) %>% 
  filter(outcome == "Died" & disease_status == "Probable")%>% 
  group_by(county) %>% 
  tally() %>% 
  replace_na(replace = list(county = "Pending address validation")) %>% 
  complete(county = tbl_county$County, fill = list(n = 0))
tbl_prob_dec$county <- factor(tbl_prob_dec$county ,level = tbl_county$County, labels = tbl_county$County)
tbl_prob_dec <- tbl_prob_dec %>% arrange(county)



tbl_cty_sum <- tibble(
  'County' = tbl_county$County,
  'cases.confirmed' = tbl_confirmed_cases$n,
  'cases.probable' = tbl_probable_cases$n,
  'dec.confirmed' = tbl_confirmed_dec$n,
  'dec.probable' = tbl_prob_dec$n
)



typology <- data.frame(
  col_keys = c("County", "cases.confirmed", "cases.probable", "dec.confirmed", "dec.probable"),
  what = c("County", "COVID-19 Cases", "COVID-19 Cases", "COVID-19-Associated Deaths", "COVID-19-Associated Deaths" ),
  measure = c("County", "Confirmed", "Probable","Confirmed", "Probable"),
  stringsAsFactors = FALSE
)

tbl <- flextable(tbl_cty_sum)
tbl <- set_header_df(tbl, mapping = typology, key = "col_keys")
tbl <- merge_h(tbl, part = "header")
tbl <- merge_v(tbl, part = "header")
n1sum <- as.character(sum(tbl_cty_sum$cases.confirmed))
n2sum <- as.character(sum(tbl_cty_sum$cases.probable))
n3sum <- as.character(sum(tbl_cty_sum$dec.confirmed))
n4sum <- as.character(sum(tbl_cty_sum$dec.probable))

tbl <-  tbl %>% 
  add_footer(values = c( County = "Total", 
                        cases.confirmed = n1sum,
                        cases.probable = n2sum,
                        dec.confirmed = n3sum,
                        dec.probable= n4sum
                        ))

tbl <- theme_booktabs(tbl)
tbl <- flextable::autofit(tbl)
tbl <- fix_border_issues(tbl)
tbl <- height_all(tbl, height = .2)
tbl <- align_nottext_col(tbl,align = "center")
tbl <- bold(tbl, part ="footer")
tbl <- border_outer(tbl, part = "footer")
tbl
```

[National COVID-19 statistics](https://www.cdc.gov/coronavirus/2019-ncov/cases-updates/cases-in-us.html) and information about [preventing spread of COVID-19](https://www.cdc.gov/coronavirus/2019-ncov/prevent-getting-sick/prevention.html) are available from the Centers for Disease Control and Prevention.  

__Day-to-day changes reflect newly reported cases, deaths, and tests that occurred over the last several days to week.__  All data in this report are preliminary; data for previous dates will be updated as new reports are received and data errors are corrected.  Hospitalization data were collected by the Connecticut Hospital Association.  Deaths reported to either OCME or DPH are included in the daily COVID-19 update.  
```{r new cases graphs, eval=wedthurs}
casenew <- thursday_case 
thisweek <- epiweek(Sys.Date())
thisyear <- epiyear(Sys.Date())
beginofcurmmwr <- MMWRweek2Date(MMWRyear = thisyear, MMWRweek = thisweek, MMWRday = 1)

cases_14 <- casenew %>%
 # filter(week >= thisweek-2 & week <= thisweek-1)
  filter(date>= beginofcurmmwr-14 & date <beginofcurmmwr)
cases_14_nc <- cases_14 %>%
  filter(cong_yn == "No")

num_groups <- c("None", "1 to 5", "6 to 24", "25 to 49", "51 to 100", "101 to 200", "201 to 500", "501 to 1000", "1001 to 5000")
avgratebreaks <-  c(
  "<5 cases per 100,000 or <5 reported cases",
  "5-9 cases per 100,000",
  "10-14 cases per 100,000",
  "15 or more cases per 100,000"
                    )

c14nc_count <- cases_14_nc %>%
  mutate(NAME = str_to_title(city)) %>% 
  group_by(NAME) %>% 
  tally() %>% 
  complete(NAME = town_pop18$city, fill = list(n = 0)) %>% 
  filter(!NAME == "Not Available")

#c14nc_count$n[is.na(c14nc_count$n)] <- 0
c14nc_count <- c14nc_count %>% 
  full_join(town_pop18, by = c("NAME" = "city")) %>% 
  mutate(CaseRate = round(((n/14)/pop)*100000,1),
         n2 = cut(n, breaks = c(-Inf,0,5,25,50,100,200,500,1000, Inf), labels = num_groups),
         avgrate = ifelse(n < 5 | CaseRate < 5, "<5 cases per 100,000 or <5 reported cases",
                          ifelse(CaseRate >=5 & CaseRate <10, "5-9 cases per 100,000",
                                 ifelse(CaseRate >=10 & CaseRate <15, "10-14 cases per 100,000",
                                        ifelse(CaseRate >=15,  "15 or more cases per 100,000", "Not categorized"))))
  )
c14nc_count$avgrate <- factor(c14nc_count$avgrate, labels = avgratebreaks, levels = avgratebreaks )
subdat14nc <- subdat %>% 
  left_join(
    c14nc_count, by = c("NAME" = "NAME")    
  )
subdat14nc$n2[is.na(subdat14nc$n2)] <- "None"
paletteo<- c("#fcf8f8", "#fff7bc", "#fec44f", "#d95f0e", "#993404", NA) ## fix colors

#paletteo2<- c("#fcf8f8", "#fff7bc", "#fee391", "#fec44f", "#fe9929", "#ec7014", "#cc4c02", "#8c2d04", NA)
paletteo2<- c("#fcf8f8", "#fff7bc", "#fee391", "#fec44f", "#fe9929", "#ec7014", "#cc4c02", "#8c2d04", "#e31a1c", NA)

n14ncperc <- paste0("(",round(nrow(cases_14_nc)/nrow(cases_14)*100), "%)")
com <- nrow(cases_14) - nrow(cases_14_nc)
n14cperc <- paste0("(",round(com/nrow(cases_14)*100), "%)")
```

`r if(thursday){"### COVID-19 Cases and Deaths Over Time ###  "}`


`r if(thursday){" The chart below shows the number of new COVID-19 cases reported to CT DPH by week of specimen collection or onset of illness. Case data now includes probable cases based on positive antigen test results. During the past two weeks ("}` `r if(thursday){thursday_range}` `r if(thursday){"), there were # new COVID-19 cases, including cases among people residing in the community and congregate settings, such as nursing homes, managed residential communities, and correctional facilities."}`


```{r plot_thurs_cases_week, eval = thursday}
casebyweek <- case %>% 
  mutate(year = epiyear(date)) %>% 
  # filter(week >= thisweek-12, year >=2020) %>% 
  filter(date > beginofcurmmwr-84 & date<=Sys.Date()) %>% 
  group_by(year,week) %>% 
  tally() %>% 
  mutate(
    date= MMWRweek2Date(MMWRyear = year, MMWRweek = week, MMWRday = 7)
  ) %>% 
  arrange(date) %>% 
  ungroup() %>% 
  mutate(
        date2 = format(date, "%B %d, %Y"),
        date2 = factor(date2, levels = date2, labels = date2),
        date = format(date, "%b-%d"),
        date = factor(date, levels = date, labels = date)
        )


xaxis <- length(levels(casebyweek$date))

ymaxweek <- max(casebyweek$n)
lx <- length(levels(casebyweek$date2))
xweek <-levels(casebyweek$date2)[lx]

maxlim <- round(ymaxweek /500)*500
if(maxlim<= ymaxweek ){
  maxlim <- maxlim+500
}


ggplot(casebyweek)+
  geom_col(aes(x=date, y=n), fill="lightgrey")+
  geom_text(aes(date,n,label=n), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  # geom_rect(aes(xmin = xweek , xmax = xweek , ymax = max(casebyweek$n), ymin = 0), alpha = 0.025, fill = "#d0d1e6")+
  ggplot2::annotate("rect", xmin =xaxis-.5, xmax = xaxis+.5 , ymin = 0, ymax = ymaxweek, alpha = 0.5, fill = "#d0d1e6" )+
  scale_y_continuous(limits = c(0, maxlim))+
  theme_classic()+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    title = element_text(size = 8.5)
  )+
  labs(
    title = "Number of COVID-19 Cases among Connecticut Residents\nby Week of Specimen Collection or Onset",
    subtitle = paste0(levels(casebyweek$date2)[1],"-", xweek),
    x = "Specimen Collection/ Onset Date",
    y = "Number of COVID-19 Cases",
    caption = "Shading indicates data are incomplete for the current week."
  )
```


`r if(thursday){"__Community Transmission of COVID-19 __"}` 

  `r if(thursday){"Among "}` `r if(thursday){nrow(cases_14)}` `r if(thursday){" new COVID-19 cases with specimen collection or onset date during "}` `r if(thursday){thursday_range}` `r if(thursday){", there were "}` `r if(thursday){nrow(cases_14_nc)}` `r if(thursday){" cases among people living in community settings, as shown in the map below. This corresponds to an average of "}``r if(thursday){round(nrow(cases_14_nc)/14/3572665*100000, 2)}`  `r if(thursday){" new COVID-19 cases per day per 100,000 population. Cases among people residing in nursing homes, assisted living facilities, and correctional facilities are excluded. Darker colors indicate towns with more cases."}`


`r if(thursday){"During this two-week period, there were more than 100 new COVID-19 cases in # towns.  "}`

```{r plot_thurs_community_settings, eval=thursday, dpi=300, fig.height=5, fig.width= 7}
#Case count map
ggplot(subdat14nc)+
  geom_sf(aes(fill = n2))+
  geom_sf_text(aes(label = NAME), col = "black", size = 1.5)+
  scale_fill_manual(values = paletteo2)+  #dbl check with sydney
  theme_void()+
  labs(
    fill = "COVID-19 Cases",
    title = paste0("Number of COVID-19 Cases among People Living in Community \nSettings by Town with Specimen Collection or Onset Date \nDuring ", thursday_range)
  )+
  theme(
     plot.title = element_text(size =11),
    legend.position = c(0.63,0.1),
    legend.direction = "horizontal",
    legend.title = element_text(size = 9),
    legend.text = element_text(size=9)
  )+
  guides(
    fill = guide_legend(nrow =2 )
  )
```

`r if(thursday){"*Map does not include* "}` `r if(thursday){thursday_pending_address$n}` `r if(thursday){"*cases pending address validation*"}`


`r if(thursday){"Because towns with larger populations are likely to have more cases, it is also important to look at the number of new cases per 100,000 population. The maps below show the average number of new cases per 100,000 population per day, with darker colors indicating higher rates. Cases among people residing in nursing homes, assisted living facilities, and correctional facilities are excluded."}`


`r if(thursday){"Among towns with at least 5 new cases during "}` `r if(thursday){thursday_range}` `r if(thursday){", # towns had an average rate of 15 or more cases per 100,000 population per day, shown in red in the map below."}`


```{r plot_community_settings, eval=thursday, dpi=300, fig.height=5, fig.width= 7}
avgpal <- c("#d3d3d3", "#ffffb2", "#fd8d3c", "#e31a1c")
#avgpal <- c("#d3d3d3", "#e31a1c")

ggplot(subdat14nc)+
  geom_sf(aes(fill = avgrate))+
  geom_sf_text(aes(label = NAME), col = "black", size = 1.5)+
  #scale_fill_distiller(low="white")+
  #scale_fill_distiller(palette = "Blues", direction = 1, na.value="white")+
  #(palette = "Blues", direction = -1)+
  scale_fill_manual(values = avgpal)+  #dbl check with sydney
  theme_void()+
  labs(
    fill = "Average COVID-19 Cases per 100,000 Population per Day",
    title = paste0("Average Daily Rate of COVID-19 Cases among People Living in Community Settings\nper 100,000 Population by Town\nwith Specimen Collection or Onset Date During ", thursday_range)
  )+
  theme(
    plot.title = element_text(size =11),
    legend.position = c(0.73,0.14),
    legend.direction = "vertical",
    legend.title = element_text(size = 8),
    legend.text = element_text(size=8),
    legend.key.size = unit(0.80, "line")
  )


```

`r if(thursday){"*Map does not include* "}` `r if(thursday){thursday_pending_address$n}` `r if(thursday){"*cases pending address validation*  "}`


`r if(thursday){"__Population, Number and Average Daily Rate of COVID-19 Cases among People Living in Community Settings by Town with Specimen Collection or Onset Date during__ "}` `r if(thursday){paste0(thursday_range,", ", year(thursday_range_start))}`  

`r if(thursday){"*Map does not include* "}` `r if(thursday){thursday_pending_address$n}` `r if(thursday){"*cases pending address validation*  "}`


```{r newcasetable, eval = wedthurs}

# code change Feb 2 to better capture most recent geocode table
# con <- DBI::dbConnect(odbc::odbc(), "epicenter")
# most_current_geo <- 
#   odbc::odbcListObjects(con, 
#                         catalog = "DPH_COVID_IMPORT", 
#                         schema = "dbo") %>% 
#   filter(stringr::str_detect(string = name, 
#                              pattern = "Geo_Tract")) %>%
#   tidyr::separate(data = .,
#                   col = name,
#                   sep = "_",
#                   into = c("month", "day"),
#                   extra = "drop",
#                   remove = FALSE) %>%
#   mutate(table_date = mdy(paste(month, 
#                                 day, 
#                                 year(Sys.Date()), 
#                                 sep = "-"))) %>%
#   slice_max(order_by = table_date) %>%
#   pull(name)
# 
# # table_id <- DBI::Id(catalog = "DPH_COVID_IMPORT", schema = "dbo", table = most_current_geo)
# # alltestgeo <- DBI::dbReadTable(con, table_id)
# 
# statement <- paste0("SELECT [r].[case_id]
#                               ,[r].[X]
#                               ,[r].[Y]
#                               ,[r].[geoid10]
#                               ,[r].[Name]
#                               ,[r].[License__]
#                               ,[r].[DBA]
#                               ,[r].[type]
#                     FROM [DPH_COVID_IMPORT].[dbo].[", most_current_geo,"] as [r]")
# alltestgeo <-  DBI::dbGetQuery(conn = con , statement = statement)
# 
# odbc::dbDisconnect(con)
# 
# # SLUGGISH Agreed :) I didn't write it haha -AS
# testgeo <- alltestgeo %>%
#   mutate(name = ifelse(Name %in% c("", "NULL"), NA, Name),
#          DBA = ifelse(DBA %in% c("", "NULL"), NA, DBA),
#          facil_name = if_else(is.na(name), DBA, Name),
#          cong_test = if_else(!is.na(facil_name), "Yes", "No"),
#          eventid = as.numeric(case_id)) %>%
#   rename(GEOID10 = geoid10) %>%
#   select(-c("case_id", "name", "License__", "DBA")) %>%
#   group_by(eventid) %>%
#   arrange(facil_name) %>%
#   slice(1L) %>%
#   ungroup()

# Reflects new table from Tom CTEDSS_GEOCODED_RECORDS
# eliminates expensive group and slice
# eliminates interim alltestgo df
con <- DBI::dbConnect(odbc::odbc(), "epicenter")
ghost_data <- tbl(con, sql("SELECT * FROM DPH_COVID_IMPORT.dbo.CTEDSS_GEOCODED_RECORDS"))
testgeo <-
  ghost_data %>%
  select(case_id, X, Y, geoid10, name, License__, DBA, type) %>%
  mutate(newName = if_else(name %in% c("", "NULL"), NA_character_, name),
         DBA = if_else(DBA %in% c("", "NULL"), NA_character_, DBA),
         facil_name = if_else(is.na(newName), DBA, name),
         cong_test = if_else(!is.na(facil_name), "Yes", "No"),
         eventid = as.numeric(case_id)) %>%
  rename(GEOID10 = geoid10, Name = name)  %>%
  select(-c("case_id", "newName", "License__", "DBA")) %>%
  arrange(facil_name) %>%
  collect()


odbc::dbDisconnect(con)


#dates for TESTS SHOULD NOT BE SET BY EVENT DATE. UPDATED TO ONLY USE SPEC COL or received DATE 10/15/2020.
testgeo2 <- elr_linelist %>%
  mutate(eventid = as.numeric(eventid)) %>% 
  left_join(testgeo, by = "eventid") %>%
  mutate(
    date = ifelse(!is.na(spec_col_date), spec_col_date, mdy(spec_rec_date)),
         date = as.Date(date, origin = ymd("1970-01-01")),
    mmwrweek = epiweek(date)
    ) # %>% 
  # filter(test_method %in% pcrtests2)

#limit to 14 days thursday range
test14 <- testgeo2 %>%
  filter(date >= thursday_range_start & date <= thursday_range_end )
#limit to community setting tests
test14nc <- test14 %>%
  filter(!cong_test %in% "Yes")

#count by town community only tests (exclude tests in congregate setting based on geocode results)
test14nc_ct <- test14nc %>%
  mutate(NAME = str_to_title(city)) %>% 
  group_by(NAME) %>% 
  tally(name = "Tests")
#join to geography
subdat14tnc <- subdat %>% 
  left_join(
    test14nc_ct, by = c("NAME" = "NAME")    
  )

    
######## FIX
newcasetable <- c14nc_count %>%
  select(NAME, n, pop, CaseRate) %>%
  left_join(test14nc_ct, by = "NAME") %>% 
  mutate(Cases =if_else(is.na(n), 0, n),
         CaseRate = if_else(is.na(CaseRate), 0, CaseRate),
         Tests = as.numeric(Tests),
         Tests = if_else(is.na(Tests), 0, Tests),
         DateUpdated = Sys.Date(),
         #Cases = ifelse(Cases >0 & Cases <5, "<5", Cases)
         ) %>%
  select(-n) %>% 
  #select(-c("n.x", "n.y")) %>%
  filter(NAME != "Not_available"  & NAME != "Not Available" & NAME  %in% cc_map$CITY) %>%
  rename(Town = NAME,
         Population = pop,
         Rate = CaseRate) %>%
  select(c(Town, Population, Cases, Rate, Tests, DateUpdated)) %>% 
  arrange(Town)

#drop n
#0 is 0 and 1 to 4 is <5

if(csv_write){
  write_csv(newcasetable, 
            paste0("L:/daily_reporting_figures_rdp/csv/", 
                   Sys.Date(), "/", Sys.Date(), "newcases+tests.csv"))
}

```


```{r thursdaytable, eval = thursday}
newcase_tbl_town <- newcasetable %>% 
  select(-c(DateUpdated, Tests))
newcase_tbl_town1 <- newcase_tbl_town[1:57,] %>% rename(town1 =Town, n1=Cases)
newcase_tbl_town2 <- newcase_tbl_town[58:114,] %>% rename(town2 =Town, n2=Cases)
newcase_tbl_town3 <- newcase_tbl_town[115:169,] %>% rename(town3 =Town, n3=Cases) %>% 
  mutate(
    n3 = as.character(n3),
    Population = as.character(Population),
    Rate = as.character(Rate)
         ) %>% 
  add_row(town3 = " ", n3 = " ", Population = " ", Rate = " " ) %>% 
  add_row(town3 =" ", n3 = " " , Population = " ", Rate = " ")

newcase_tbl_town <- bind_cols(newcase_tbl_town1, newcase_tbl_town2,newcase_tbl_town3)
newcase_tbl_town <- regulartable(newcase_tbl_town) #%>% 
newcase_tbl_town <- set_header_labels(newcase_tbl_town,
                        town1 = "Town",
                        town2 = "Town",
                        town3 = "Town",
                        n1 = "Cases",
                        n2 = "Cases",
                        n3 = "Cases",
                        Population = "Pop",
                        Population1 = "Pop",
                        Population2 = "Pop",
                        Rate1 = "Rate",
                        Rate2 = "Rate",
                        Rate3 = "Rate"
                         ) 
newcase_tbl_town <- font(newcase_tbl_town, fontname = "Calibri", part = "all")
newcase_tbl_town <- fontsize(newcase_tbl_town, size = 8.5, part = "all" )
newcase_tbl_town <- width(newcase_tbl_town, width = 0.75)
newcase_tbl_town <- height(newcase_tbl_town, height = .15, part = "body")
newcase_tbl_town <- align_nottext_col(newcase_tbl_town, align = "center")
newcase_tbl_town 
```



    
`r if(thursday){"__COVID-19 Molecular and Antigen Tests during__"}` `r if(thursday){thursday_range}` `r if(thursday){"  "}`

`r if(thursday){"Among "}` `r if(thursday){nrow(test14)}` `r if(thursday){"molecular and antigen tests for COVID-19 with specimen collection date during"}`  `r if(thursday){thursday_range}``r if(thursday){", "}``r if(thursday){nrow(test14nc)}` `r if(thursday){ "("}``r if(thursday){ round(nrow(test14nc)/nrow(test14)*100)}``r if(thursday){ "%) tests were conducted among people who did not reside in congregate settings (including nursing homes, assisted living, and correctional facilities). Of these "}` `r if(thursday){nrow(test14nc)}` `r if(thursday){"tests, "}` `r if(thursday){nrow(test14nc %>% filter(result == "detected"))}` `r if(thursday){"("}``r if(thursday){round(nrow(test14nc %>% filter(result == "detected"))/nrow(test14nc)*100)}``r if(thursday){"%)"}``r if(thursday){" were positive. The map below shows the number of molecular and antigen COVID-19 tests by town with specimen collection date during "}``r if(thursday){thursday_range}` `r if(thursday){" that were conducted among community residents."}`
    
    
     
```{r newcasetable , eval= thursday, dpi=300, fig.height=5, fig.width= 7}     
#make map
ggplot(subdat14tnc)+
  geom_sf(aes(fill = Tests))+ # was originally just n, I changed to n.y
  geom_sf_text(aes(label = NAME), col = "black", size = 1.5)+
  scale_fill_distiller(palette = "Blues", direction = 1, na.value="white")+
  theme_void()+
  labs(
    fill = "COVID-19 Tests",
    title = paste0("Number of Molecular and Antigen Tests for COVID-19 among\nPeople Living in Community Settings by Town\nwith Specimen Collection Date During ", thursday_range)
  )+
  theme(
     plot.title = element_text(size =11),
    legend.position = c(0.63,0.1),
    legend.direction = "horizontal",
    legend.title = element_text(size = 11),
    legend.text = element_text(size=7)
  )

```
`r if(thursday){"*Map does not include tests pending address validation*  "}`

`r if(thursday){"__Age Distribution of COVID-19 Cases with Specimen Collection or Onset During"}` `r if(thursday){thursday_range}` `r if(thursday){", 2020__  "}`

```{r plot_thurs_onset, eval=thursday}
#11. Age breakdown of new cases
cases_14 <- cases_14 %>%
  mutate(age_group = cut(age, breaks = c(-1,9,19,29,39,49,59,69,79, Inf),labels = age_labels))

dfs_age <- cases_14 %>%
  group_by(age_group) %>% 
  tally() %>% 
  filter(!is.na(age_group))

ggplot(dfs_age)+
  geom_col(aes(age_group,n, fill = age_group), col = "black")+
  geom_text(aes(age_group,n,label=n), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = paste0("Number of New COVID-19 Cases by Age Group \nwith Collection or Onset during ", thursday_range),
       #subtitle = default_subtitle,
       y = "Number of Cases",
       x="Age (years)")

```
`r if(thursday){"__Average Daily Incidence by Age Group__  "}`

`r if(thursday){"The chart below shows the average number of new COVID-19 cases per day per 100,000 population by age group. The rates in this chart are calculated by averaging the number of new cases diagnosed each day during the previous two weeks, dividing by the annual population in each age group, and then multiplying by 100,000.  "}`


```{r plot_thurs_rate_by_age, eval=thursday, dpi=300, fig.height=6, fig.width= 7}
weeks <-  case %>%
  select(date,mmwrweek) %>%
  mutate(
    #year = 2020,
    year = epiyear(date),
    mmwrweekdate = MMWRweek2Date(MMWRyear=year, MMWRweek=mmwrweek, MMWRday=7)
  ) %>% 
  # filter(mmwrweek >= epiweek(Sys.Date())-9) %>% 
  filter(date >= beginofcurmmwr-63 & date <= Sys.Date()) %>%  
  select(mmwrweekdate) %>% 
  arrange(mmwrweekdate) %>%
  filter(!is.na(mmwrweekdate)) %>% 
  unique()
maxweeks <- max(weeks$mmwrweekdate, na.rm = T)-7
minweeks <- min(weeks$mmwrweekdate, na.rm = T)
weeks <- seq.Date(from = minweeks, to =  maxweeks, by= "7 days")

### duplicate????

# age_labels <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", ">=80")
# 
# pop <- read_csv("L:/daily_reporting_figures_rdp/population_data/2018_dph_asrh/2018_asrh.csv") %>% 
#   select(age_g, total) %>% 
#   filter(!is.na(age_g))
# 

agegrp <- case %>%
  mutate(
    #year = 2020,
    year = epiyear(date),
    mmwrweekdate = MMWRweek2Date(MMWRyear=year, MMWRweek=mmwrweek, MMWRday=7)
  ) %>% 
 filter(mmwrweekdate %in% weeks) %>% 
  mutate(age_group = 
           cut(age, breaks = c(-1,9,19,29,39,49,59,69,79, Inf),labels = age_labels)) %>% 
  group_by(age_group,mmwrweekdate) %>% 
  tally() %>% 
  filter(!is.na(age_group)) %>% 
  complete(mmwrweekdate = weeks, fill = list( n = 0)) %>%  
  mutate(n2 = lag(n)) %>%
  filter(!is.na(mmwrweekdate) &  !is.na(n2)) %>% 
  arrange(mmwrweekdate) %>% 
  mutate(n3 = n+n2) %>% 
  left_join(pop, by=c("age_group" = "age_g")) %>% 
  ungroup() %>% 
  mutate(
    mmwrweekdate = factor(mmwrweekdate),
    rate_100k = (n3/14/total)*100000,
    age_group = factor(age_group, labels = age_labels, levels = age_labels )
         )


maxlim <- round(max(agegrp$rate_100k)/2.5)*2.5
if(maxlim<= max(agegrp$rate_100k)){
  maxlim <- maxlim+2.5
}

graphdate <- Sys.Date() - 1
ggplot(agegrp, aes(x = mmwrweekdate, 
                   y = rate_100k,
                   color = age_group, 
                   group = age_group)) +
  geom_line(size = 1) +
  ylim(0, maxlim) +
  #scale_y_continuous(breaks= seq(0, 100, by =25))+
  #scale_x_date(date_labels = "%b-%d", date_breaks = "7 days")+#limits=c(ymd("2020-06-18", max(agegrp$date))), date_labels = "%b-%d", date_breaks = "7 days")+
  scale_color_brewer(palette = "Paired") +
  theme_minimal() +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x=element_text(angle=45,hjust=1),
    legend.background = element_rect(),
    #legend.justification=c(1,1),
    legend.position = "bottom"
  ) +
  labs(
    title= "Average daily rate of COVID-19 cases by age group",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    x = NULL,
    y = "Rate per 100,000 population",
    color = "Age group (years)"
  ) +
  guides(
    col = guide_legend(nrow = 3)
  )

save(agegrp,
     file = paste0("l:/recent_rdata/for_josh.RData" ))


epi_connect <- DBI::dbConnect(odbc::odbc(), "epicenter")
ghost_data <- tbl(epi_connect, sql("SELECT * FROM DPH_COVID_IMPORT.dbo.RPT_STATE_REA_DENOMS"))

vaccine_pop <-
  ghost_data %>%
  filter(year == 2019) %>%
  group_by(vax_age_groups) %>%
  summarise(poppy = sum(pop, na.rm = TRUE)) %>%
  rename(age_g = vax_age_groups,
         total = poppy) %>%
  arrange(vax_age_groups) %>%
  collect()

odbc::dbDisconnect(epi_connect)

vaccine_labels <- c("<=15", "16-24", "25-34", "35-44", "45-54", "55-64", "65-74", "75+")

nagegrp <- case %>%
  mutate(
    #year = 2020,
    year = epiyear(date),
    mmwrweekdate = MMWRweek2Date(MMWRyear = year, 
                                 MMWRweek = mmwrweek, 
                                 MMWRday=7)
  ) %>% 
 filter(mmwrweekdate %in% weeks) %>% 
  mutate(age_group = 
           cut(age, breaks = c(-1, 15, 24, 34, 44, 54, 64, 74, Inf), 
               labels = vaccine_labels)) %>% 
  group_by(age_group, mmwrweekdate) %>% 
  tally() %>% 
  filter(!is.na(age_group)) %>% 
  complete(mmwrweekdate = weeks, fill = list( n = 0)) %>%  
  mutate(n2 = lag(n)) %>%
  filter(!is.na(mmwrweekdate) &  !is.na(n2)) %>% 
  arrange(mmwrweekdate) %>% 
  mutate(n3 = n + n2) %>% 
  left_join(vaccine_pop, by=c("age_group" = "age_g")) %>% 
  ungroup() %>% 
  mutate(
    mmwrweekdate = factor(mmwrweekdate),
    rate_100k = (n3/14/total)*100000,
    age_group = factor(age_group, labels = vaccine_labels, levels = vaccine_labels )
         )

ggplot(nagegrp, aes(x = mmwrweekdate, 
                   y = rate_100k,
                   color = age_group, 
                   group = age_group)) +
  geom_line(size = 1) +
  ylim(0, maxlim) +
  scale_color_brewer(palette = "Paired") +
  theme_minimal() +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x=element_text(angle=45, hjust=1),
    legend.background = element_rect(),
    legend.position = "bottom"
  ) +
  labs(
    title= "Average daily rate of COVID-19 cases by vaccine age group",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    x = NULL,
    y = "Rate per 100,000 population",
    color = "Age group (years)"
  ) +
  guides(
    col = guide_legend(nrow = 2)
  )

```

`r if(thursday){"**Average Daily Incidence by County**"}`

`r if(thursday){"The chart below shows the average number of new COVID-19 cases per day per 100,000 population in the state of Connecticut and for each Connecticut county. The rates in this chart are calculated by averaging the number of new cases diagnosed each day during the previous two weeks, dividing by the annual estimated population, and then multiplying by 100,000.  "}`

```{r plot_thurs_cases_county, message=FALSE, warning=FALSE, fig.align= "center", eval=thursday, dpi=300, fig.height=5, fig.width= 7}

#incidence by county
countypop <- read_csv("L:/daily_reporting_figures_rdp/population_data/county_pop.csv") %>%
  mutate(County = paste0(County, " County")) %>%
  rename(pop = Total)


wkincidencect <- case %>%
  mutate(
    #year = 2020,
    year = epiyear(date),
    mmwrweekdate = MMWRweek2Date(MMWRyear=year, MMWRweek=mmwrweek, MMWRday=7)
  ) %>% 
  filter(!is.na(county) & mmwrweekdate %in% weeks) %>% 
  group_by(mmwrweekdate) %>%
  tally() %>%
  complete(mmwrweekdate = weeks, fill = list( n = 0)) %>%  
  mutate(n2 = lag(n)) %>%
  filter(!is.na(mmwrweekdate) &  !is.na(n2)) %>% 
  arrange(mmwrweekdate) %>% 
  mutate(n3 = n+n2) %>% 
  mutate(rate=(n3/14)/3572665 *100000, 
         County="Connecticut",
          mmwrweekdate = factor(mmwrweekdate)
         )

 

wkincidence <- case %>%
   mutate(
    #year = 2020,
    year = epiyear(date),
    mmwrweekdate = MMWRweek2Date(MMWRyear=year, MMWRweek=mmwrweek, MMWRday=7)
  ) %>% 
  filter(!is.na(county) & mmwrweekdate %in% weeks) %>% 
  group_by(county, mmwrweekdate) %>%
  tally() %>%
  complete(mmwrweekdate = weeks, fill = list( n = 0)) %>%  
  mutate(n2 = lag(n)) %>%
  filter(!is.na(mmwrweekdate) &  !is.na(n2)) %>% 
  arrange(mmwrweekdate) %>% 
  rename(County = county) %>% 
  left_join(countypop, by="County") %>%
  mutate(n3 = n+n2) %>% 
  mutate(rate=(n3/14)/pop *100000,
          mmwrweekdate = factor(mmwrweekdate)
         )

  
weekincidence <- bind_rows(wkincidence, wkincidencect) 

maxlim <- round(max(weekincidence$rate)/5)*5
if(maxlim<= max(weekincidence$rate)){
  maxlim <- maxlim+5
}

ggplot(weekincidence, aes(mmwrweekdate, rate, col = County, group = County))+
  geom_line(size =1)+
  ylim(0, maxlim)+
  #scale_x_date( date_labels = "%b-%d", date_breaks = "7 days")+
  scale_color_brewer(palette = "Paired")+
  theme_minimal()+
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x=element_text(angle=45,hjust=1),
    legend.background = element_rect(),
    legend.text = element_text(size =7),
    legend.title =  element_text(size =8),
    title = element_text(size = 10),
    #legend.justification=c(1,1),
    legend.position = "bottom"
  )+
  labs(
    title= "Average daily rates of COVID-19 cases by county",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    x="",
    y="Rate per 100,000 population"
  )+
  guides(
   col = guide_legend(nrow = 3)
  )
```


`r if(thursday){"__Cumulative Number of COVID-19 Cases and COVID-19-Associated Deaths by Date__  "}`

`r if(thursday){"_Test results may be reported several days after the result. Data are incomplete for most recent dates shaded in grey. Data from previous dates are routinely updated._  "}`


```{r plot_thurs_cases_date, message=FALSE, warning=FALSE, fig.align= "center", eval = thursday, dpi = 300}
case <- case %>% filter(date >= "2020-03-01" & date < Sys.Date())

case_epi <- case %>% 
  filter(disease_status  == "Confirmed") %>% 
  group_by(date) %>% 
  tally() %>% 
  filter(!is.na(date)) %>% 
  mutate(type = "Confirmed")


#confirmed > specimen date then probable date of symp onsent, if na then report date
prob_epi <- case %>% 
 filter(disease_status  == "Probable") %>%
  group_by(date) %>% 
  tally() %>% 
  filter(!is.na(date)) %>% 
  mutate(
    type = "Probable"
  )
epicurve <- bind_rows(case_epi, prob_epi) %>% 
  arrange(date) %>% 
  mutate(type = factor(type, levels = c("Probable", "Confirmed"), labels = c("Probable", "Confirmed")))

ymx <- epicurve %>% group_by(date) %>%  summarize(n=sum(n)) %>%  select(n) %>%  max(.$n)
 
epicurve %>% 
  ggplot()+
  geom_col(aes(date, n, fill = type), width = 1)+
  geom_rect(aes(xmin = Sys.Date()-5.5, xmax =max(epicurve$date)+1, ymax = ymx, ymin = 0), col = "black", alpha = 0.01, fill = "gray")+
  scale_x_date(date_labels = "%b-%d", date_breaks = "2 weeks", limits = c(ymd("2020-03-04"),max(epicurve$date)+1))+
  scale_fill_manual(values = c('#7fcdbb',"#2c7fb8" ))+
  #scale_fill_brewer(palette = "BuGn", direction = -1, drop = FALSE, guide = guide_legend(reverse = TRUE))+
  theme_minimal()+
  theme(
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=33,hjust=1)
        )+
  labs(
    title = "Number of Confirmed and Probable \nCOVID-19 Cases by Date",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    y = "Number of Cases",
    x=paste0("Date of Specimen Collection (confirmed)\nor Symptom Onset/Postive Antigen Test Date (probable)"),
    fill = ""
    )

```


```{r plot_thursday_deaths, message=FALSE, warning=FALSE, fig.align= "center" , eval = thursday}
dfs_daily_dead <- case %>%
  ungroup() %>%
  filter(outcome == "Died") %>%
  select(death_date) %>%
  filter(year(death_date)>=2020) %>% 
  group_by(death_date) %>% 
  tally() %>% 
  filter(!is.na(death_date))
dfs_daily_dead <- dfs_daily_dead %>% 
    complete(
      death_date = seq.Date(min(death_date), max(death_date), by = "day"), fill =list(n = 0)
             )
decymx <- max(dfs_daily_dead$n)

dfs_daily_dead_proto <- case %>%
  ungroup() %>%
  filter(outcome == "Died") %>%
  select(death_date, disease_status ) %>%
  filter(year(death_date)>=2020) %>% 
  group_by(death_date, disease_status) %>% 
  tally() %>% 
  filter(!is.na(death_date))
  dfs_daily_dead_proto <- dfs_daily_dead_proto %>% 
    complete(
      death_date= seq.Date(min(death_date), max(death_date), by = "day"), disease_status = c("Confirmed", "Probable"), fill =list(n = 0)
             )
ggplot(dfs_daily_dead_proto)+
  geom_col(aes(death_date, n, fill =factor(disease_status, levels = c("Probable", "Confirmed"))), width =1)+
  geom_rect(aes(xmin = Sys.Date()-4.5, xmax = Sys.Date(), ymax = decymx , ymin = 0), col = "black", alpha = 0.01, fill = "gray")+
  #scale_fill_brewer(palette = "Blues", drop = FALSE, guide = guide_legend(reverse = TRUE))+
  scale_fill_manual(values = c('#7fcdbb',"#2c7fb8" ))+
  scale_x_date(date_labels = "%b-%d", date_breaks = "2 weeks", limits = c(as.Date("2020-03-06"), Sys.Date()))+
  theme_minimal()+
  theme(
    legend.position = "bottom",
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x=element_text(angle=33,hjust=1)
        )+
  labs(
    title ="Number of COVID-19-Associated Deaths\nby Date of Death",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
      y = "Number of Deaths",
       x="Date of Death",
    fill = "")

``` 

### Hospitalization Surveillance  

The map below shows the number of patients currently hospitalized with laboratory-confirmed COVID-19 by county based on data collected by the Connecticut Hospital Association. The distribution is by location of hospital, not patient residence. The labels indicate the number of patients currently hospitalized with the change since yesterday in parentheses.  

**Patients Currently Hospitalized by Connecticut County**  

*Distribution by location of hospital not patient residence. Data from the Connecticut Hospital Association.*  

```{r plot_hospitalizations, message=FALSE, warning=FALSE, dpi=300, fig.height=5, fig.width= 7}
ggplot(subdat2)+
  geom_sf(aes(fill = ngrp), col= "black")+
  geom_sf_label(aes(label =paste0(NAME, "\n",today, " (",sign, Change, ")") ), col = "black", size =3)+#, size = 6)+
  scale_fill_brewer(palette = "Oranges")+
  theme_void()+
  labs(
    fill = "Hospitalized\nCOVID-19 Cases"
  )+
   theme(
   legend.position = c(0.60,0.1),
     legend.direction = "horizontal",
     legend.title = element_text(size = 9),
     legend.text = element_text(size=9)
   )
```
More information about hospitalized cases of COVID-19 in New Haven and Middlesex Counties is available from [COVID-NET.](https://gis.cdc.gov/grasp/COVIDNet/COVID19_3.html) 



```{r hospital_census, message=FALSE, warning=FALSE, include=FALSE}
total_hosp <- cha %>%
  filter(Type == "CumAdmit" & State == "TOTAL")
total_hosp <-  total_hosp[ncol(total_hosp)-1]%>% 
  rename(today = names(total_hosp[ncol(total_hosp)-1]))
total_discharged <- cha %>% 
  filter(Type == 'Discharge' & State == "TOTAL")
total_discharged <- total_discharged[ncol(total_discharged)-1] %>% 
  rename(today = names(total_discharged[ncol(total_discharged)-1]))
```





`r if(thursday){"**COVID-19 Hospital Census in Connecticut**"}`

 `r if(thursday){"The chart below shows the COVID-19 hospital census, which is the number of patients currently hospitalized with laboratory-confirmed COVID-19 on each day. Data were collected by the Connecticut Hospital Association and are shown since August 1, 2020"}`

```{r hosp_cuml,  message=FALSE, warning=FALSE, eval = thursday}
newcha2 <- newcha %>% 
    filter(admit_date >= "2020-08-01")
           
maxlimit25 <- (round(max(newcha2$admissions)/25)*25)+25
if(maxlimit25<= max(newcha2$admissions)){
  maxlimit25 <- maxlimit2+25
}

ggplot(data = newcha2)+
geom_line(mapping = aes(x = admit_date, y = admissions), size = 1)+
scale_x_date(date_breaks = "2 weeks", date_labels = "%b-%d")+
scale_y_continuous(expand = c(0,0), limits = c(0,maxlimit25))+
theme_classic()+
theme(axis.text.x = element_text(
  angle = 45,
  hjust=1
  ))+
  labs(
    x = "Date",
    y = paste0("Number of patients hospitalized with COVID-19"),
    title= "Number of patients hospitalized\nwith laboratory-confirmed COVID-19 by Day",
    subtitle ="",#"text for us to see for an example" ,
    caption =""#text for us to see for an example"   
  )


deadweeks <- as.character(seq.Date(as.Date("2020-08-01"), Sys.Date(), by = "7 days"))

deadbar <- case %>% 
  filter(outcome == "Died") %>% 
  filter(!is.na(death_date) & death_date >="2020-08-01") %>%
  mutate(
    deadweek=epiweek(death_date),
    deadyear=epiyear(death_date),
    deaddate= MMWRweek2Date(MMWRyear = deadyear, MMWRweek = deadweek, MMWRday = 7)
  ) %>% 
  filter(as.character(deaddate) %in% deadweeks) %>% 
  group_by(deaddate,cong_yn) %>% 
  tally() %>% 
  ungroup() %>% 
  arrange(deaddate) %>% 
  mutate(deaddate = factor(deaddate)) %>% 
  complete(deaddate = deadweeks, 
           cong_yn =c("Yes", "No"),
           fill = list(n = 0)) 

deadbarmax <- deadbar %>% 
  group_by(deaddate) %>% 
  summarise(n= sum(n)) %>% 
  top_n(1) %>% 
  select(n)
maxlimit6 <- (round(deadbarmax$n/5)*5)+5
if(maxlimit6<= deadbarmax$n){
  maxlimit6 <- maxlimit6+5
} 
ggplot(deadbar)+
  geom_col(aes(deaddate, n, fill = cong_yn), col = "black")+
  #geom_text(aes(deaddate,n,label=n), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  # scale_fill_brewer(palette = "Paired")+
  # scale_fill_manual(values = c('#7fcdbb',"#2c7fb8" ))+
  scale_y_continuous(limits = c(0,maxlimit6))+
  scale_fill_manual(values = c('#d8b365',"#5ab4ac" ))+
  theme_classic()+
  theme(axis.text.x = element_text(
  angle = 45,
  hjust=1
  ))+
  labs(
    x = "Week of Death",
    y = "Number of Deaths",
    title= "COVID-19 Deaths by Date of Death",
    fill = "Resident of Congregate Setting"
  )+
  theme_minimal()+
  theme(
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust=1)
        )

```

`r if(thursday){"### Daycare Surveillance"}`

`r if(thursday){"Licensed daycare providers are required to report cases of COVID-19 among attendees and staff to the Department of Public Health (DPH) and the local health department. This figure shows the number of cases among daycare attendees and staff reported to DPH since September 1, 2020. Data are preliminary and like other passive surveillance systems, under reporting occurs and the true incidence of disease is more than the number of cases reported."}`
```{r plot_daycare_data, message=FALSE, warning=FALSE, fig.align="center", eval=thursday}
########### DAYCARE EDITS ###############
## set logic: no attendees 6+, attendees 18+ are assumed to be staff
attendee_to_staff <- case %>% 
  filter(daycare_attendee == "YES" & age >=18)
edit_daycare <- case %>% 
  mutate(daycare_attendee = ifelse(age >=6, "NO", daycare_attendee))%>%
  mutate(daycare_staff = ifelse(eventid %in% attendee_to_staff$eventid, "YES", daycare_staff))
  
## hardcode edits after logic: 12/17:
edit_daycare$daycare_staff[edit_daycare$eventid %in% c(101096038, 102729292, 102939247, 101346815, 102851466, 102755473, 103255551, 101708189, 103226614, 103382925, 103191123, 103315505)]<- "NO"

 

edit_daycare$daycare_attendee[edit_daycare$eventid %in% c(103382925)]<- "NO"


daycare_attendee <- edit_daycare %>% 
  filter(daycare_attendee == "YES")%>% 
  select(c(eventid, date, mmwrweek, week))%>%
  mutate(year = epiyear(date)) %>% 
  filter(date < Sys.Date())%>%
  filter((week > 35 & year ==2020) | (week >= 1 & year ==2021)) %>% 
  group_by(year,week) %>% 
  tally()%>%
  mutate(role="Attendees")%>%
  ungroup()
daycare_attendee1 <- edit_daycare %>% 
  filter(daycare_attendee == "YES")%>% 
  select(c(eventid, date, mmwrweek, week))%>%
  mutate(year = epiyear(date)) %>% 
  filter((week > 35 & year ==2020) | (week >= 1 & year ==2021)) %>% 
  group_by(year,week) 

 

daycare_staff <- edit_daycare %>%  
  filter(daycare_staff == "YES")%>% 
  select(c(eventid, date, mmwrweek, week))%>%
  mutate(year = epiyear(date)) %>% 
  filter(date < Sys.Date())%>%
  filter((week > 35 & year ==2020) | (week>= 1 & year==2021)) %>% 
  group_by(year,week) %>% 
  tally() %>% 
  mutate(role="Staff")%>%
  ungroup()

 

daycare_staff1 <- edit_daycare %>%  
  filter(daycare_staff == "YES")%>% 
  select(c(eventid, date, mmwrweek, week))%>%
  mutate(year = epiyear(date)) %>% 
  filter((week > 35 & year ==2020) | (week>= 1 & year==2021)) %>% 
  group_by(year,week)

 

daycare <- bind_rows(daycare_attendee, daycare_staff)%>%
  mutate(
    date= MMWRweek2Date(MMWRyear = year, MMWRweek = week, MMWRday = 7)
  ) %>% 
  arrange(date) %>% 
  mutate(
        date = format(date, "%b-%d"),
        date = factor(date, levels = date, labels = date)
        )

 

ggplot(daycare, aes(x=date, y=n, fill=role))+
  geom_bar(stat = "identity", color="black")+
  scale_fill_manual(name="",values = c('#7fcdbb',"#2c7fb8" ))+
  labs(x="Week", y="Number of Cases", title = "Daycare Associated Cases")+
  theme_classic()+
theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    title = element_text(size = 7.5)
  )
```

`r if(thursday){"### Laboratory Surveillance"}  `

`r if(thursday){"Molecular Tests"}  `

`r if(thursday){"To date, DPH has received reports on a total of "}` `r if(thursday){total_pcr_tests}` `r if(thursday){" molecular COVID-19 laboratory tests; of these"}` `r if(thursday) {number_of_elr} ` `r if(thursday){"test results were received via electronic laboratory reporting (ELR) methods from commercial laboratories, hospital laboratories, and the Dr. Katherine A. Kelley State Public Health Laboratory. The chart below shows the number of tests reported via ELR by date of specimen collection and test result."}`  

`r if(thursday){"*Test results may be reported several days after specimen collection. Data are incomplete for most recent dates shaded in grey. Data for previous dates are routinely updated.*"}`


```{r plot_pcr_test_by_date,  message=FALSE, warning=FALSE, fig.align= "center", eval=thursday, dpi=300}
elr_linelist_elronly %>% 
  filter(spec_col_date >= "2020-02-28" & result %in% c("detected", "not detected")) %>% 
  mutate(result = ifelse(result == "detected", "Positive", "Negative")) %>% 
  group_by(spec_col_date, result) %>% 
  tally() %>% 
ggplot()+
  geom_col(aes(spec_col_date, n, fill = result))+
  geom_rect(aes(xmin = Sys.Date()-4.5, xmax = Sys.Date(), ymax = max(n) , ymin = 0), col = "black", alpha = 0.01, fill = "gray")+
  #scale_fill_brewer(palette = "Blues")+
  scale_fill_manual(values = c('#7fcdbb',"#2c7fb8" ))+
  scale_x_date(date_labels = "%b-%d", date_breaks = "2 weeks", limits = c(ymd("2020-03-03"), Sys.Date()))+
  theme_minimal()+
  theme(
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = c(0.25,0.8),
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust=1)
        )+
  labs(
    title = "Number of Molecular Laboratory Tests for COVID-19 \nReported via ELR by Specimen Collection Date ",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    y = "Number of Tests",
    x="Specimen Collection Date",
    fill = "",
    caption = "Shading indicates data are incomplete for the current week."
    )
```
`r if(thursday){"*Testing of recently collected specimens is ongoing and does not reflect a decrease in testing. Chart only includes test results received by electronic laboratory reporting.*"}`  

`r if(thursday){"*ELR = Electronic Laboratory Reporting*"}`


`r if(thursday){"To date, DPH has received reports on a total of "}` `r if(thursday){total_ag_tests}`  `r if(thursday){" COVID-19 antigen laboratory tests. The chart below shows the number of antigen tests reported to DPH by specimen collection date and test result."}`

`r if(thursday){"*Test results may be reported several days after specimen collection. Data are incomplete for most recent dates shaded in grey. Data for previous dates are routinely updated.*"}`
```{r plot_antigen_tests_by_date,  message=FALSE, warning=FALSE, fig.align= "center", eval=thursday, dpi=300}
elr_linelist %>% 
  filter(spec_col_date >= "2020-08-01" & test_method %in% agtests & result %in% c("detected", "not detected")) %>% 
  mutate(result = ifelse(result == "detected", "Positive", "Negative")) %>% 
  group_by(spec_col_date, result) %>% 
  tally() %>% 
ggplot()+
  geom_col(aes(spec_col_date, n, fill = result))+
  geom_rect(aes(xmin = Sys.Date()-4.5, xmax = Sys.Date(), ymax = max(n) , ymin = 0), col = "black", alpha = 0.01, fill = "gray")+
  #scale_fill_brewer(palette = "Blues")+
  scale_fill_manual(values = c('#7fcdbb',"#2c7fb8" ))+
  scale_x_date(date_labels = "%b-%d", date_breaks = "2 weeks", limits = c(ymd("2020-08-01"), Sys.Date()))+
  theme_minimal()+
  theme(
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = c(0.25,0.8),
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust=1)
        )+
  labs(
    title = "Number of Antigen Tests for COVID-19 Reported\nby Specimen Collection Date ",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    y = "Number of Tests",
    x="Specimen Collection Date",
    fill = "",
    caption = "Shading indicates data are incomplete for the current week."
    )

```
  
`r if(thursday){"*Testing of recently collected specimens is ongoing and does not reflect a decrease in testing.*"}`  



### Characteristics of COVID-19 Cases and Associated Deaths  

```{r plot_cases_by_date, message=FALSE, warning=FALSE, fig.align= "center", eval = not_thursday}
case_epi <- case %>% 
  filter(disease_status  == "Confirmed") %>% 
  group_by(date) %>% 
  tally() %>% 
  filter(!is.na(date)) %>% 
  mutate(type = "Confirmed")


#confirmed > specimen date then probable date of symp onsent, if na then report date
prob_epi <- case %>% 
 filter(disease_status  == "Probable") %>%
  group_by(date) %>% 
  tally() %>% 
  filter(!is.na(date)) %>% 
  mutate(
    type = "Probable"
  )
epicurve <- bind_rows(case_epi, prob_epi) %>% 
  filter(date >= ymd("2020-08-01")) %>% 
  arrange(date) %>% 
  mutate(type = factor(type, levels = c("Probable", "Confirmed"), labels = c("Probable", "Confirmed")))

ymx <- epicurve %>% group_by(date) %>%  summarize(n=sum(n)) %>%  select(n) %>%  max(.$n)
 
epicurve %>% 
  ggplot()+
  geom_col(aes(date, n, fill = type), width = 1)+
  geom_rect(aes(xmin = Sys.Date()-5.5, xmax =max(epicurve$date)+1, ymax = ymx, ymin = 0), col = "black", alpha = 0.01, fill = "gray")+
   scale_x_date(date_labels = "%b-%d", date_breaks = "2 weeks", limits = c(ymd("2020-08-01"),max(epicurve$date)+1))+
  scale_fill_manual(values = c('#7fcdbb',"#2c7fb8" ))+
  theme_minimal()+
  theme(
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust=1)
        )+
  labs(
    title = "Number of Confirmed and Probable \nCOVID-19 Cases by Date",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    y = "Number of Cases",
    x=paste0("Date of Specimen Collection (confirmed)\nor Symptom Onset/Postive Antigen Test Date (probable)"),
    fill = ""
    )

```


```{r plot_deaths_by_date, message=FALSE, warning=FALSE, fig.align= "center" , eval = not_thursday}
dfs_daily_dead <- case %>%
  ungroup() %>%
  filter(outcome == "Died") %>%
  select(death_date) %>%
  filter(year(death_date)>=2020) %>% 
  group_by(death_date) %>% 
  tally() %>% 
  filter(!is.na(death_date))
dfs_daily_dead <- dfs_daily_dead %>% 
    complete(
      death_date = seq.Date(min(death_date), max(death_date), by = "day"), fill =list(n = 0)
             )


dfs_daily_dead_proto <- case %>%
  ungroup() %>%
  filter(outcome == "Died") %>%
  select(death_date, disease_status ) %>%
  filter(death_date >= ymd("2020-08-01")) %>% 
  group_by(death_date, disease_status) %>% 
  tally() %>% 
  filter(!is.na(death_date))
  dfs_daily_dead_proto <- dfs_daily_dead_proto %>% 
    complete(
      death_date= seq.Date(min(death_date), max(death_date), by = "day"), disease_status = c("Confirmed", "Probable"), fill =list(n = 0)
             ) %>% 
    group_by(death_date) %>% 
    mutate(n2 = sum(n)) %>% 
    ungroup()
  
  
  decymx <- max(dfs_daily_dead_proto$n2)
  
ggplot(dfs_daily_dead_proto)+
  geom_col(aes(death_date, n, fill =factor(disease_status, levels = c("Probable", "Confirmed"))), width =1)+
  geom_rect(aes(xmin = Sys.Date()-7, xmax = Sys.Date(), ymax = decymx , ymin = 0), col = "black", alpha = 0.01, fill = "gray")+
   scale_x_date(date_labels = "%b-%d", date_breaks = "2 weeks", limits = c(ymd("2020-08-01"),max(epicurve$date)+1))+
  scale_fill_manual(values = c('#7fcdbb',"#2c7fb8" ))+
  theme_minimal()+
  theme(
    legend.position = "bottom",
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x=element_text(angle=45,hjust=1)
        )+
  labs(
    title ="Number of COVID-19-Associated Deaths\nby Date of Death",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
      y = "Number of Deaths",
       x="Date of Death",
    fill = "")


```


  `r if(thursday){"*Counts may not add up to total case count because demographic data may be missing.*"}`

```{r plot_cases_by_age, message=FALSE, warning=FALSE, fig.align= "center", eval = thursday}
dfs_age <- case %>%
  group_by(age_group) %>% 
  tally() %>% 
  filter(!is.na(age_group))

ggplot(dfs_age)+
  geom_col(aes(age_group,n, fill = age_group), col = "black")+
  geom_text(aes(age_group,n,label=n), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Number of COVID-19 Cases\nby Age Group",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Number of Cases",
       x="Age(years)")
```


```{r plot_deaths_by_age, message=FALSE, warning=FALSE, fig.align= "center", eval = thursday}
dfs_age_d <- case %>%
  ungroup() %>% 
  filter(outcome == "Died" & !is.na(age_group)) %>% 
  group_by(age_group) %>% 
  tally() %>% 
  complete(age_group = age_labels, fill = list( n = 0)) %>%
    mutate(age_group = factor(age_group, levels = age_labels, labels = age_labels),
           type = "Lab Confirmed") %>% 
  arrange(age_group)
nmx <- dfs_age_d %>% 
  group_by(age_group) %>% 
  tally() %>% 
  ungroup()
ggplot(dfs_age_d)+
  geom_col(aes(age_group, n, fill = age_group), col = "black")+
  geom_text(aes(age_group,n,label=n), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues", drop = FALSE)+
  scale_x_discrete(drop = FALSE) +
  #scale_y_continuous(breaks = seq(0, max(nmx$n), by =2))+
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Number of COVID-19-Associated Deaths\nby Age Group",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Number of Cases",
       x="Age(years)")

```


`r if(thursday){"*Counts may not add up to total case count because demographic data may be missing.*"}`

```{r not_sure18,  message=FALSE, warning=FALSE, include=FALSE}
gender_race_eth <- read_csv("L:/daily_reporting_figures_rdp/population_data/county_re_gender_age.csv")
```


```{r plot_cases_by_gender,  message=FALSE, warning=FALSE, fig.align= "center" , eval = thursday}
gender_count <- case %>% 
  count(gender)
gender_count_byday <- case %>% 
  group_by(gender, date) %>% 
  tally()
gender_rate_lookup <- gender_race_eth %>% 
  group_by(gender) %>% 
  summarize(tot = sum(n)) %>% 
  mutate(gender = ifelse(gender == "f", "Female", "Male"))
gender_total_rate <- gender_count %>% 
  left_join(gender_rate_lookup) %>% 
  mutate(rate = round((n/tot)*100000))
gender_count_dec <- case %>% 
  filter(outcome == "Died") %>% 
  count(gender)
gender_total_rate_dec <- gender_count_dec %>% 
  left_join(gender_rate_lookup) %>% 
  mutate(rate = round((n/tot)*100000))
ggplot(
  gender_count %>% 
    filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
)+
  geom_col(aes(gender,n, fill = gender), col = "black")+
  geom_text(aes(gender,n,label=n), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Number of COVID-19 Cases\nby Gender",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Number of Cases",
       x="")
```


```{r plot_deaths_by_gender,  message=FALSE, warning=FALSE, fig.align= "center", eval = thursday}
ggplot(
  gender_count_dec %>% 
    filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
)+
  geom_col(aes(gender,n, fill = gender), col = "black")+
  geom_text(aes(gender,n,label=n), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Number of COVID-19-Associated Deaths\nby Gender",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Number of Cases",
       x="")


```




### Cumulative Number of COVID-19 Cases by Town  

*Map does not include `r pendingaddress_text` cases pending address validation*  

```{r plot_cum_cases_town, message=FALSE, warning=FALSE, dpi=500, fig.height=7, fig.width= 9 }
ggplot(subdat)+
  geom_sf(aes(fill = n))+
  geom_sf_text(aes(label = NAME), col = "black", size = 1.5)+
  scale_fill_brewer(palette = "Oranges")+
  theme_void()+
  labs(
    fill = "COVID-19 Cases")+
   theme(
     legend.position = c(0.63,0.1),
     legend.direction = "horizontal",
     legend.title = element_text(size = 11),
     legend.text = element_text(size=11)
   )
```



**APPENDIX A. Cumulative Number of COVID-19 Cases by Town**  
*Table does not include `r pendingaddress_text` cases pending address validation*
```{r tables_by_town, message=FALSE, warning=FALSE}
tbl_town_confirmed_cases <- case %>% 
  filter(disease_status == "Confirmed") %>% 
  filter(!is.na(city)& city!= "Not Available" ) %>% 
  group_by(city) %>%
  tally(name = "Confirmed Cases") %>% 
  complete(city = cc_map$CITY, fill = list("Confirmed Cases" = 0)) %>% 
  rename(Town = city)

tbl_town_probable_cases <- case %>% 
  filter(disease_status == "Probable") %>% 
  filter(!is.na(city)& city!= "Not Available" ) %>% 
  group_by(city) %>%
  tally(name = "Probable Cases") %>% 
  complete(city = cc_map$CITY, fill = list("Probable Cases" = 0)) %>% 
  rename(Town = city)

tbl_town_confirmed_cases1 <- tbl_town_confirmed_cases[1:57,] %>% rename(town1 =Town, n1="Confirmed Cases")
tbl_town_confirmed_cases2 <- tbl_town_confirmed_cases[58:114,] %>% rename(town2 =Town, n2="Confirmed Cases")
tbl_town_confirmed_cases3 <- tbl_town_confirmed_cases[115:169,] %>% rename(town3 =Town, n3="Confirmed Cases") %>% 
  mutate(n3 = as.character(n3)) %>% 
  add_row(town3 = " ", n3 = " " ) %>% 
  add_row(town3 =" ", n3 = " " )
tbl_town_probable_cases1 <- tbl_town_probable_cases[1:57,] %>% rename(m1='Probable Cases') %>% select(-Town)  
tbl_town_probable_cases2 <- tbl_town_probable_cases[58:114,] %>% rename(m2='Probable Cases') %>% select(-Town) 
tbl_town_probable_cases3 <- tbl_town_probable_cases[115:169,] %>% rename(m3='Probable Cases') %>% select(-Town) %>% 
  mutate(m3 = as.character(m3)) %>% 
  add_row( m3 = " " ) %>% 
  add_row( m3 = " " )

tbl_town_cases4 <- bind_cols(tbl_town_confirmed_cases1,tbl_town_probable_cases1,  tbl_town_confirmed_cases2,tbl_town_probable_cases2, tbl_town_confirmed_cases3,tbl_town_probable_cases3)
tbl_towns <- regulartable(tbl_town_cases4) #%>% 
tbl_towns <- set_header_labels(tbl_towns,
                        town1 = "Town",
                        town2 = "Town",
                        town3 = "Town",
                        n1 = "Confirmed Cases",
                        n2 = "Confirmed Cases",
                        n3 = "Confirmed Cases",
                        m1 = "Probable Cases",
                        m2 = "Probable Cases",
                        m3 = "Probable Cases"
                         ) #%>% 
tbl_towns <- font(tbl_towns, fontname = "Calibri", part = "all")
tbl_towns <- fontsize(tbl_towns, size = 8.5, part = "all" )
tbl_towns <- width(tbl_towns, width = 0.75)
tbl_towns <- height(tbl_towns, height = .15, part = "body")
tbl_towns <- align_nottext_col(tbl_towns, align = "center")
tbl_towns 
```


**APPENDIX B.** The following graphs show the number of cases per 100,000 Connecticut residents statewide and by county, age group, and gender. Population estimate from: [DPH Population Statistics](https://portal.ct.gov/DPH/Health-Information-Systems--Reporting/Population/Population-Statistics)  

```{r plot_state_county, message=FALSE, warning=FALSE, fig.align= "center", dpi=300, eval=thursday}
st_case_rate <-tibble(geo = "Connecticut", rate = round((nrow(case)/3572665)*100000), type = "Case Rate") 
st_dec_rate <- tibble(geo = "Connecticut",rate = round((
  nrow(
    case %>%
      filter(outcome == "Died"))/3572665)*100000), type = "Death Rate")
state_rates <- bind_rows(st_case_rate, st_dec_rate) %>% 
  mutate(color = "a")
county_case_rates <- case %>%
  group_by(county) %>% 
  tally() %>% 
  left_join(county_pop, by=  c("county" = "County")) %>% 
  mutate(rate = round((n/Total)*100000)) %>% 
  filter(!is.na(county)) %>% 
  select(county, rate) %>% 
  rename(geo=county) %>% 
  mutate(type ="Case Rate", color = "b")
county_dec_rates <- case %>% 
  filter(outcome == "Died") %>% 
  group_by(county) %>% 
  tally() %>% 
  left_join(county_pop, by=  c("county" = "County")) %>% 
  mutate(rate = round((n/Total)*100000)) %>% 
  filter(!is.na(county)) %>% 
  select(county, rate)%>% 
  rename(geo=county) %>% 
  mutate(type = "Death Rate", color = "b") 
state_wide_rates <- bind_rows(state_rates, county_dec_rates, county_case_rates) 

ggplot(state_wide_rates%>% filter(type!="Death Rate") , aes(geo, rate, fill = color)) +
  geom_bar( col = "black", stat = "identity")+
  geom_text(aes(geo,rate, label = rate), size =2.5, vjust=-0.25)+
  scale_fill_brewer(palette = "Blues", direction =-1)+
  theme_classic()+
  theme(
    axis.text.x=element_text(angle=45,hjust=1),
    legend.position = "none"
  )+
  labs(
      title = "Rate of COVID-19 Cases Statewide\nand by County",
      subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
        x="",
       y="Rate per 100,000 Population",
       fill = "")

ggplot(state_wide_rates%>% filter(type =="Death Rate") , aes(geo, rate, fill = color)) +
  geom_bar( col = "black", stat = "identity")+
  geom_text(aes(geo,rate, label = rate), size =2.5, vjust=-0.25)+
  scale_fill_brewer(palette = "Blues", direction =-1)+
  theme_classic()+
  theme(
    axis.text.x=element_text(angle=45,hjust=1),
    legend.position = "none"
  )+
  labs(
      title = "Rate of COVID-19-Associated Deaths\nStatewide and by County",
      subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
        x="",
       y="Rate per 100,000 Population",
       fill = "")
```


```{r plot_thurs_deaths_by_age, message=FALSE, warning=FALSE, fig.align= "center", eval=thursday}
dfs_per_capita <- case %>%
  ungroup() %>% 
  group_by(age_group) %>% 
  tally() %>%
  filter(!is.na(age_group)) %>% 
  left_join(pop, by=c("age_group" = "age_g")) %>% 
  ungroup() %>% 
  mutate(rate_100k = (n/total)*100000) %>% 
  select(-c(n,total))
dfs_per_capita$age_group <- factor(dfs_per_capita$age_group, labels = age_labels, levels = age_labels )
ggplot(dfs_per_capita)+
  geom_col(aes(age_group, rate_100k, fill = age_group), col = "black")+
  geom_text(aes(age_group,rate_100k,label=round(rate_100k)), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues", drop = FALSE)+
  scale_x_discrete(drop = FALSE) +
  theme_classic()+
  theme(legend.position = "none")+
  labs(
      title = "Rate of COVID-19 Cases\nby Age Group",
      subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Rate per 100,000 CT Population",
       x="Age (years)")


dfs_age_d %>% 
  bind_cols(pop) %>% 
  select(-c(type, age_g)) %>% 
  mutate(dec_rate = round(n/total*100000)) %>% 
  ggplot()+
  geom_col(aes(age_group, dec_rate, fill = age_group), col = "black")+
  geom_text(aes(age_group,dec_rate ,label=dec_rate), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues", drop = FALSE)+
  scale_x_discrete(drop = FALSE) +
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Rate of COVID-19-Associated Deaths\nby Age Group",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Rate per 100,000 Population",
       x="Age (years)")
```



```{r plot_deaths_gender, message=FALSE, warning=FALSE, fig.align= "center", eval=thursday}
gender_total_rate_dec <- gender_count_dec %>% 
  left_join(gender_rate_lookup) %>% 
  mutate(rate = round((n/tot)*100000))
ggplot(
  gender_total_rate %>% 
    filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
       )+
  geom_col(aes(gender,rate, fill = gender), col = "black")+
  geom_text(aes(gender,rate,label=rate), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Rate of COVID-19 Cases\nby Gender",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Rate per 100,000 CT Population",
       x="")


gender_total_rate_dec %>% 
    filter(!is.na(gender) & gender != "Unknown") %>% 
  ggplot()+
  geom_col(aes(gender,rate, fill = gender), col = "black")+
  geom_text(aes(gender,rate,label=rate), position = position_dodge(width=0.9), vjust =-0.25, size = 3.3)+
  scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Rate of COVID-19-Associated Deaths\nby Gender",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Rate per 100,000 Population",
       x="")


```

**APPENDIX C.** The following graphs show the number of cases and deaths by race and ethnicity. *Categories are mutually exclusive. The category "multiracial" includes people who answered 'yes' to more than one race category. NH=Non-Hispanic*  

```{r plot_cases_age_ethnicity, message=FALSE, warning=FALSE, fig.align= "center"}
race_eth_SHA_lookup <- gender_race_eth %>% 
  group_by(hisp_race) %>%  
  summarize(tot=sum(n))
race_eth_SHA_case <- case %>%
  group_by(hisp_race) %>% 
  tally(name = "case_tot")

race_eth_comb <- race_eth_SHA_case %>% 
  left_join(race_eth_SHA_lookup) %>% 
  mutate(rate100k = round((case_tot/tot)*100000))

####dec
race_eth_SHA_case_dec <- case %>%
  filter(outcome == "Died") %>% 
  group_by(hisp_race) %>%  
  tally(name = "deaths")


race_eth_comb <- race_eth_comb %>% 
  left_join(race_eth_SHA_case_dec) %>% 
  replace_na(replace =list(deaths = 0)) %>% 
  rename(caserate100k=rate100k) %>% 
  mutate(deathrate100k = round((deaths/tot)*100000))
race_eth_comb$hisp_race <- factor(race_eth_comb$hisp_race, levels =c("Hispanic", "NH White", "NH Black", "NH American Indian or Alaskan Native", "NH Asian or Pacific Islander", "NH Other", "NH Multiracial", "Unknown") , labels =c("Hispanic", "NH White", "NH Black", "NH American Indian or Alaskan Native", "NH Asian or Pacific Islander", "NH Other", "NH Multiracial", "Unknown"))

maxlimit2 <- (round(max(race_eth_comb$case_tot)/10000)*10000)+10000
if(maxlimit2<= max(race_eth_comb$case_tot)){
  maxlimit2 <- maxlimit2+10000
}


ggplot(
  race_eth_comb #%>% 
)+
  geom_col(aes(stringr::str_wrap(hisp_race,20), case_tot, fill = stringr::str_wrap(hisp_race,20)), col = "black")+
  geom_text(aes(stringr::str_wrap(hisp_race,20), case_tot, label = case_tot), position = position_dodge(width=0.9), vjust =-0.25, size = 2.9)+
  scale_fill_brewer(palette = "Blues")+
  scale_y_continuous(limits = c(0,maxlimit2 ), breaks = seq(0,maxlimit2,10000))+
  theme_classic()+
  theme(legend.position = "none",
         axis.text.x=element_text(angle=45,hjust=1),
        )+
  labs(
    title = "Number of COVID-19 Cases\nby Race\\Ethnicity",
       subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
       y = "Number of Cases",
       x="")

```


```{r plot_deaths_age_ethnicity, fig.align="center", message=FALSE, warning=FALSE, dpi = 300}
maxlimit3 <- (round(max(race_eth_comb$deaths)/1000)*1000)+1000
if(maxlimit3<= max(race_eth_comb$deaths)){
  maxlimit3 <- maxlimit3+1000
}

ggplot(
  race_eth_comb #%>% 
)+
  geom_col(aes(stringr::str_wrap(hisp_race,20), deaths, fill = stringr::str_wrap(hisp_race,20)), col = "black")+
  geom_text(aes(stringr::str_wrap(hisp_race,20), deaths, label = deaths), position = position_dodge(width=0.9), vjust =-0.25, size = 2.9)+
  scale_fill_brewer(palette = "Blues")+
   scale_y_continuous(limits = c(0,maxlimit3 ), breaks = seq(0,maxlimit3,1000))+
  theme_classic()+
  theme(
    legend.position = "none",
     axis.text.x=element_text(angle=45,hjust=1)
    )+
  labs(
    title = "Number of COVID-19-Associated Deaths\nby Race\\Ethnicity",
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    y = "Number of Deaths",
    x="")
```
  
The following graphs show the number of COVID-19 cases and COVID-19-associated deaths per 100,000 population by race and ethnicity. Crude rates represent the total cases or deaths per 100,000 people.  Age-adjusted rates consider the age of the person at diagnosis or death when estimating the rate and use a standardized population to provide a fair comparison between population groups with different age distributions. Age-adjustment is important in Connecticut as the median age of among the non-Hispanic white population is 47 years, whereas it is 34 years among non-Hispanic blacks, and 29 years among Hispanics. Because most non-Hispanic white residents who died were over 75 years of age, the age-adjusted rates are lower than the unadjusted rates. In contrast, Hispanic residents who died tend to be younger than 75 years of age which results in higher age-adjusted rates.

The 2018 Connecticut and 2000 US Standard Million populations were used for age adjustment; population estimates from: [DPH Population Statistics.](https://portal.ct.gov/DPH/Health-Information-Systems--Reporting/Population/Population-Statistics) *Categories are mutually exclusive. Cases missing data on race/ethnicity are excluded from calculation of rates. NH=Non-Hispanic*

```{r plot_age_ethnicity, message=FALSE, warning=FALSE, fig.align= "center", dpi = 300}
stanpopas <- read_csv("L:/daily_reporting_figures_rdp/dependancies/stanpopas.csv")

aamr_lookup <- read_csv("L:/daily_reporting_figures_rdp/dependancies/2018_State-level_ASRH _lookup.csv") %>% 
  rename(age_g = "Age Group")
aamr_lookup <- aamr_lookup %>% 
  pivot_longer(-age_g, names_to = "hisp_race", values_to = "denominator") %>% 
  mutate(
    gender = str_sub(hisp_race, start = str_length(hisp_race), end  = str_length(hisp_race)),
    age_g = ifelse(
      age_g %in% c("<1 yrs", "1-4 yrs"),
      "<5 yrs",
      age_g
    ),
    hisp_race = ifelse(
      str_sub(hisp_race,start = 1L, end = 1L) == "H",
      "Hispanic",
      hisp_race
    ),
    hisp_race = str_replace(hisp_race, " F| M", ""),
    hisp_race = str_replace(hisp_race, "AI", "American Indian or Alaskan Native"),
    hisp_race = str_replace(hisp_race, "API", "Asian or Pacific Islander"),
    gender = ifelse(gender == "M", "Male", "Female")
  ) %>% 
  group_by(hisp_race, age_g) %>% 
  summarize(denominator = sum(denominator))


case_by_age <-  case %>% 
  select(age, hisp_race) %>% 
  filter(!is.na(hisp_race) & !is.na(age) & age>=0 & !hisp_race %in% c("NH Other", "Unknown", "NH Multiracial")) %>% 
  mutate(
    age_group2 = ifelse(
      age <5, "<5 yrs",
      ifelse(
        age >=5 & age <10, "5-9 yrs",
        ifelse(
          age >=10 & age <15, "10-14 yrs",
          ifelse(
            age >=15 & age <20, "15-19 yrs",
            ifelse(
              age >=20 & age <25, "20-24 yrs",
              ifelse(
                age >=25 & age <30, "25-29 yrs",
                ifelse(
                  age >=30 & age <35, "30-34 yrs",
                  ifelse(
                    age >=35 & age <40, "35-39 yrs",
                    ifelse(
                      age >=40 & age <45, "40-44 yrs",
                      ifelse(
                        age >=45 & age <50, "45-49 yrs",
                        ifelse(
                          age >=50 & age <55, "50-54 yrs",
                          ifelse(
                            age >=55 & age <60, "55-59 yrs",
                            ifelse(
                              age >=60 & age <65, "60-64 yrs",
                              ifelse(
                                age >=65 & age <70, "65-69 yrs",
                                ifelse(
                                  age >=70 & age <75, "70-74 yrs",
                                  ifelse(
                                    age >=75 & age <80, "75-79 yrs",
                                    ifelse(
                                      age >=80 & age <85, "80-84 yrs",
                                      ifelse(
                                        age >=85 , "85+ yrs",
                                        age
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
    )
  )


case_by_age_grouped <- case_by_age %>% 
  group_by(hisp_race,  age_group2) %>% 
  tally()


aamr_lookup_grouped <- aamr_lookup %>% 
  group_by(hisp_race, age_g) %>% 
  summarise(denominator = sum(denominator))


agg_table <- aamr_lookup_grouped %>% 
  left_join(case_by_age_grouped, by = c("hisp_race" = "hisp_race", "age_g" = "age_group2")) %>% 
  left_join(stanpopas, by = "age_g") %>%
  replace_na(replace =  list(n= 0)) %>% 
  mutate(
    crude_rate = n/denominator*100000
  ) %>% 
  group_by(age_g) %>% 
  mutate(standard_age_g = sum(spop2000)) %>% 
  group_by(hisp_race) %>% 
  mutate(
    propn = standard_age_g/sum(standard_age_g),
    hisp_race_case_tot = sum(n),
    hisp_race_stan_tot = sum(denominator)
  ) %>% 
  ungroup() %>% 
  mutate(age_specific_adjusted = crude_rate * propn,
        Crude = hisp_race_case_tot/hisp_race_stan_tot*100000) %>% 
  group_by(hisp_race) %>% 
  mutate(`Age adjusted` = sum(age_specific_adjusted))


adj_table <- agg_table %>% 
  select(hisp_race, Crude, `Age adjusted`) %>% 
  unique()

adj_tbl_long <- adj_table %>% 
  pivot_longer(-hisp_race, names_to = "rate_type", values_to = "n") %>%
  mutate(rate_type= factor(rate_type, levels=c("Crude", "Age adjusted"), labels=c("Crude", "Age adjusted")),
         n = round(n))



 
maxlimit2 <- round(max(adj_tbl_long$n)/500)*500
if(maxlimit2<= max(adj_tbl_long$n)){
  maxlimit2 <- maxlimit2+500
}

ggplot(adj_tbl_long, aes(fill = rate_type, y = n, x = hisp_race))+
  geom_bar(aes(stringr::str_wrap(hisp_race,20)), position = "dodge",stat = 'identity', col = "black")+
  geom_text(aes(stringr::str_wrap(hisp_race,20), n, label = n), position = position_dodge(width=0.9), vjust =-0.25, size =3.3)+
  scale_fill_brewer(palette = "Blues")+
  scale_y_continuous(limits=c(0, maxlimit2))+
  theme_classic()+
  labs(
    fill = "",
    y="Cases per 100,000 population",
    x="",
    title=paste0("Rate of COVID-19 Cases by Race/Ethnicity, \nwith and without age adjustment"), 
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y"))
  )+
  theme(
    legend.position = c(0.43, .9),
    legend.direction = "vertical",
    legend.title = element_text(size = 9),
    legend.text = element_text(size=9),
    axis.text.x.bottom = element_text(angle = 45, hjust = 1)
  )


dec_by_age <-  case %>% 
  filter(outcome == "Died") %>% 
  select(age, hisp_race) %>% 
  filter(!is.na(hisp_race) & !is.na(age) & age>=0 & !hisp_race %in% c("NH Other", "Unknown", "NH Multiracial") ) %>% 
  mutate(
    age_group2 = ifelse(
      age <5, "<5 yrs",
      ifelse(
        age >=5 & age <10, "5-9 yrs",
        ifelse(
          age >=10 & age <15, "10-14 yrs",
          ifelse(
            age >=15 & age <20, "15-19 yrs",
            ifelse(
              age >=20 & age <25, "20-24 yrs",
              ifelse(
                age >=25 & age <30, "25-29 yrs",
                ifelse(
                  age >=30 & age <35, "30-34 yrs",
                  ifelse(
                    age >=35 & age <40, "35-39 yrs",
                    ifelse(
                      age >=40 & age <45, "40-44 yrs",
                      ifelse(
                        age >=45 & age <50, "45-49 yrs",
                        ifelse(
                          age >=50 & age <55, "50-54 yrs",
                          ifelse(
                            age >=55 & age <60, "55-59 yrs",
                            ifelse(
                              age >=60 & age <65, "60-64 yrs",
                              ifelse(
                                age >=65 & age <70, "65-69 yrs",
                                ifelse(
                                  age >=70 & age <75, "70-74 yrs",
                                  ifelse(
                                    age >=75 & age <80, "75-79 yrs",
                                    ifelse(
                                      age >=80 & age <85, "80-84 yrs",
                                      ifelse(
                                        age >=85 , "85+ yrs",
                                        age
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
    )
  )


dec_by_age_grouped <- dec_by_age %>% 
  group_by(hisp_race, age_group2) %>% 
  tally()


aamr_lookup_grouped <- aamr_lookup %>% 
  group_by(hisp_race, age_g) %>% 
  summarise(denominator = sum(denominator))


agg_table_dec <- aamr_lookup_grouped%>% 
  left_join(dec_by_age_grouped, by = c("hisp_race" = "hisp_race", "age_g" = "age_group2")) %>% 
  left_join(stanpopas, by="age_g") %>%
  replace_na(replace =  list(n= 0)) %>% 
  mutate(
    crude_rate = n/denominator*100000
  ) %>% 
  group_by(age_g) %>% 
  mutate(standard_age_g = sum(spop2000)) %>% 
  group_by(hisp_race) %>% 
  mutate(
    propn = standard_age_g/sum(standard_age_g),
    hisp_race_case_tot = sum(n),
    hisp_race_stan_tot = sum(denominator)
  ) %>% 
  ungroup() %>% 
  mutate(age_specific_adjusted = ifelse(
      hisp_race_case_tot >=20, crude_rate * propn, NA
      ),
        Crude = hisp_race_case_tot/hisp_race_stan_tot*100000) %>% 
  group_by(hisp_race) %>% 
  mutate(`Age adjusted` = sum(age_specific_adjusted))



adj_table_dec <- agg_table_dec %>% 
  select(hisp_race, Crude, `Age adjusted`) %>% 
  unique()

adj_tbl_long_dec <- adj_table_dec %>% 
  pivot_longer(-hisp_race, names_to = "rate_type", values_to = "n") %>%
  mutate(rate_type= factor(rate_type, levels=c("Crude", "Age adjusted"), labels=c("Crude", "Age adjusted")),
         n = round(n))

maxlimit3 <- round(max(adj_tbl_long_dec$n, na.rm = T)/200)*200
if(maxlimit3 <= max(adj_tbl_long_dec$n, na.rm = T)){
  maxlimit3 <- maxlimit3+200
}



ggplot(adj_tbl_long_dec, aes(fill = rate_type, y = n, x = hisp_race))+
  geom_bar(aes(stringr::str_wrap(hisp_race,20)), position = "dodge",stat = 'identity',  col = "black")+
  geom_text(aes(stringr::str_wrap(hisp_race,20), n, label = n), position = position_dodge(width=0.9), vjust =-0.25, size =2.9)+
  scale_fill_brewer(palette = "Blues")+
  scale_y_continuous(limits=c(0, maxlimit3))+
  theme_classic()+
  labs(
    fill = "",
    y="Deaths per 100,000 population",
    x="",
    title=paste0("Rate of COVID-19-Associated Deaths\nby Race/Ethnicity, with and without age adjustment*"), 
    subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y"))
  )+
  theme(
    legend.position = c(0.25,0.9),
    legend.direction = "horizontal",
    legend.title = element_text(size = 9),
    legend.text = element_text(size=9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```
  

```{r plot_disproportion, message=FALSE, warning=FALSE, fig.align= "center", dpi = 600, eval= FALSE}
re_grp <- race_eth_comb %>%
  select(hisp_race, tot, deaths) %>%
  mutate(
    'Percentage of Connecticut Population' = round(tot/sum(tot, na.rm = T)*100),
    'Percentage of COVID-19-Associated Deaths' =  round(deaths/sum(deaths, na.rm = T)*100)
  ) %>%
  filter(!hisp_race %in% c("NH Other", "NH Unknown"))

longer <- re_grp %>% 
  select(hisp_race, 'Percentage of Connecticut Population', 'Percentage of COVID-19-Associated Deaths')

longer <- pivot_longer(longer, -hisp_race, names_to = "type", values_to = "perc") %>% 
  filter(!hisp_race %in% c("NH Multiracial", "Unknown"))

ggplot(longer, aes(stringr::str_wrap(hisp_race,15), perc, fill = type))+
  geom_bar( col = "black", stat = "identity", position = position_dodge())+
  geom_text(aes(stringr::str_wrap(hisp_race,15),perc, label = perc), position = position_dodge(1), vjust=-0.25, size =3.3)+
  scale_fill_brewer(palette = "Blues", direction = -1)+
  theme_classic()+
  labs(
    title = 'Non-Hispanic black people disproportionately\naffected by COVID-19 deaths in Connecticut',
      subtitle = paste0("As of ", format(graphdate, "%m/%d/%Y")),
    fill = "",
    y = "Percent (%)",
    x = ""
  )+
  theme(
    legend.position = c(0.25, 0.8),
    legend.direction = "vertical",
      legend.background = element_blank()
  )
```
_\*Age adjusted rates only calculated for groups with at least 30 deaths_


```{r gary, message=FALSE, warning=FALSE, include=FALSE}
path2 <- paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date())
dir.create(path2)
#state
State <- tibble("State" = "CONNECTICUT")
LastUpdateDate <- tibble("LastUppdateDate" = graphdate)#tibble("LastUppdateDate" = max(as.Date(mdy(case$`Event Date`))))
TotalCases <- tibble('TotalCases'= nrow(case))
ConfirmedCases <- tibble("ConfirmedCases" = nrow(case %>% filter(disease_status == "Confirmed")))
ProbableCases <- tibble("ProbableCases" = nrow(case %>% filter(disease_status == "Probable")))
HospitalizedCases <- tibble(HospitalizedCases = cha_c$today[9])
TotalDeaths <- tibble("Deaths" = dec)
ConfirmedDeaths <- tibble("ConfirmedDeaths" = nrow(case %>%  filter(outcome == "Died" & disease_status == "Confirmed")))
ProbableDeaths <-  tibble("ProbableDeaths" = nrow(case %>%  filter(outcome == "Died" & disease_status == "Probable")))
 
gary_age_labels <- c("cases_age0_9", "cases_age10_19", "cases_age20_29", "cases_age30_39", "cases_age40_49", "cases_age50_59", "cases_age60_69", "cases_age70_79", "cases_age80_Older" )
gary_ages <- case %>%
  group_by(age_group) %>%
  tally() %>%
  filter(!is.na(age_group)) %>%
  pivot_wider(names_from = age_group, values_from = n)
gary_state_file <-  bind_cols(State, LastUpdateDate, TotalCases, ConfirmedCases,ProbableCases, HospitalizedCases, TotalDeaths, ConfirmedDeaths, ProbableDeaths,gary_ages)

if (csv_write) {
  write_csv(gary_state_file, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/state_Result.csv"))
}
if (SQL_write) {
  df_to_table(gary_state_file, "ODP_state_Result", overwrite = TRUE, append = FALSE)
}

#town
town_codes <- read_csv("L:/daily_reporting_figures_rdp/gary_csv/town_codes/Town_ID.csv") %>%
  select(ANPSADPI,TOWNNO)
town_total_cases <- case %>% 
    filter(city != "Not_available") %>% 
  group_by(city) %>% 
  tally() %>%
  rename(CITY = city) %>% 
  complete(CITY = cc_map$CITY, fill = list(n = 0))
town_confirmed_cases <- case %>% 
  filter(disease_status == "Confirmed") %>% 
    filter(city != "Not_available") %>% 
  group_by(city) %>% 
  tally() %>%
  rename(CITY = city) %>% 
  complete(CITY = cc_map$CITY, fill = list(n = 0))
town_probable_cases <- case %>% 
  filter(disease_status == "Probable") %>% 
    filter(city != "Not_available") %>% 
  group_by(city) %>% 
  tally() %>%
  rename(CITY = city) %>% 
  complete(CITY = cc_map$CITY, fill = list(n = 0))
town_total_deaths <- case %>%
  filter(outcome == "Died")%>%
  filter(city != "Not_available") %>% 
  group_by(city) %>%
  tally(name = "Deaths") %>% 
  rename(CITY = city)%>% 
  complete(CITY = cc_map$CITY, fill = list(n = 0))
town_confirmed_deaths <- case %>%
  filter(outcome == "Died" & disease_status == "Confirmed")%>%
    filter(city != "Not_available") %>% 
  group_by(city) %>%
  tally(name = "Deaths") %>% 
  rename(CITY = city)%>% 
  complete(CITY = cc_map$CITY, fill = list(n = 0))
town_probable_deaths <- case %>%
  filter(outcome == "Died" & disease_status == "Probable")%>%
    filter(city != "Not_available") %>% 
  group_by(city) %>%
  tally(name = "Deaths") %>% 
  rename(CITY = city) %>% 
  complete(CITY = cc_map$CITY, fill = list(n = 0))
TownCaseRate <- case %>%
  filter(!is.na(city) & city != "Not_available") %>% 
  group_by(city) %>% 
  tally(name ='case_n') %>% 
  complete(city = cc_map$CITY, fill = list(case_n = 0)) %>% 
  left_join(town_pop18, by = c( "city" = "city")) %>% 
  mutate(CaseRate = round((case_n/pop)*100000),
         CITY = paste0(city, " town")
         ) %>% 
  select(-c(case_n, pop, city)) 

town_tests <- elr_linelist
town_tests$result[town_tests$result == "detected"] <- "Positive"
town_tests$result[town_tests$result == "not detected"] <- "Negative"
town_tests$result[town_tests$result == "indeterminate"] <- "Indeterminate"

town_tests <- town_tests %>% 
filter(!is.na(city) & !city %in% c("Not_available", "Pending validation")) %>% 
  group_by(city, result) %>%
  tally() %>%
  pivot_wider(id_cols = city, names_from = result, values_from = n) %>%
  replace_na(replace = list(Positive = 0, Negative= 0, Indeterminate = 0)) %>%
  mutate(state="CT",
         number_of_tests=sum(Positive, Negative, Indeterminate, na.rm=TRUE)) %>%
  rename(number_of_positives = Positive,
         number_of_negatives = Negative,
         number_of_indeterminates = Indeterminate,
         town = city)


#count people tested by town
#has ag implications
peopletestbytown<- elr_linelist %>% 
   mutate(simple_result = ifelse( 
          # str_detect(string = str_to_lower(result),
          #            pattern = "(?<!not )detected|positive"
          #            ),
          result == "detected",
          1,2
          )
         ) %>%
  group_by(bigID) %>%
  arrange(simple_result,spec_col_date) %>%
  slice(1L) %>%
  ungroup() %>% 
  rename(Town = city, SpecimenCollectionDate = spec_col_date) %>% 
  group_by(Town) %>% 
  tally(name = "PeopleTested") %>% 
  filter(Town != "Not_available") %>% 
  mutate(Town = str_to_title(Town)) %>% 
  left_join(town_pop18, by = c("Town" = "city")) %>% 
  mutate(RateTested100k = round(PeopleTested/pop * 100000)) %>% 
  select(-pop)


gary_town_file <- tibble(
  CITY = town_total_cases$CITY,
  LastUpdateDate = graphdate,
  TownTotalCases = town_total_cases$n,
   TownConfirmedCases = town_confirmed_cases$n,
   TownProbableCases = town_probable_cases$n,
   TownTotalDeaths = town_total_deaths$Deaths,
   TownConfirmedDeaths = town_confirmed_deaths$Deaths,
   TownProbableDeaths = town_probable_deaths$Deaths,
   TownCaseRate = TownCaseRate$CaseRate,
   PeopleTested = peopletestbytown$PeopleTested,
   NumberofTests = town_tests$number_of_tests,
   NumberofPositives = town_tests$number_of_positives,
   NumberofNegatives = town_tests$number_of_negatives,
   NumberofIndeterminates = town_tests$number_of_indeterminates,
   RateTested100k = peopletestbytown$RateTested100k
) %>%
  mutate(CITY = paste0(CITY," town")) %>%
  left_join(town_codes, by = c("CITY" = "ANPSADPI"))%>%
  rename(Town_No = TOWNNO,
         Town = CITY) %>%
  select(Town_No, everything()) %>%
  filter(!is.na(Town_No)) %>% 
  mutate(Town = paste0(str_replace(Town, " town", "")))
gary_town_file[is.na(gary_town_file)] <- 0

if (csv_write) {
  write_csv(gary_town_file, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/town_Result.csv"))
}
if (SQL_write) {
  df_to_table(gary_town_file, "ODP_town_Result", overwrite = TRUE, append = FALSE)
}



#ConProbByDate.csv
ConProbByDate <- epicurve %>%
            filter(!is.na(date) & date >= "2020-03-05") %>%
            rename(Date = date, CaseCount = n ) %>% 
            pivot_wider(id_cols = Date, names_from = type, values_from = CaseCount) 
ConProbByDate[is.na(ConProbByDate)] <- 0
ConProbByDate <- ConProbByDate %>% 
  mutate(Total =  Confirmed + Probable)


if (csv_write) {
  write_csv(ConProbByDate, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/ConProbByDate.csv"))
}
if (SQL_write) {
  df_to_table(ConProbByDate, "ODP_ConProbByDate", overwrite = TRUE, append = FALSE)
}

#gendersummary
gender_tots <- gender_race_eth %>% 
  group_by(gender) %>% 
  summarize(n=sum(n)) %>% 
  mutate(gender = ifelse(gender == "m",
                         "Male",
                         "Female"
                         ))
gstotalcase <- case %>% 
  group_by(gender) %>% 
  tally(name = "Cases") %>% 
  filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
gsconfirmedcase <- case %>% 
  filter(disease_status == "Confirmed") %>% 
  group_by(gender) %>% 
  tally(name = "Cases") %>% 
  filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
gsprobcase <- case %>% 
  filter(disease_status == "Probable") %>% 
  group_by(gender) %>% 
  tally(name = "Cases") %>% 
  filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))  
gstotaldeaths <- case %>% 
 filter(outcome =="Died") %>% 
  group_by(gender) %>% 
  tally(name = "Deaths")  %>% 
  filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
gstotaldeaths <- case %>% 
 filter(outcome =="Died") %>% 
  group_by(gender) %>% 
  tally(name = "Deaths")  %>% 
  filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
gsconfdeaths <- case %>% 
 filter(disease_status == "Confirmed" & outcome =="Died") %>% 
  group_by(gender) %>% 
  tally(name = "Deaths")  %>% 
  filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
gsprobdeaths <- case %>% 
 filter(disease_status == "Probable" & outcome =="Died") %>% 
  group_by(gender) %>% 
  tally(name = "Deaths")  %>% 
  filter(!is.na(gender) & !gender %in% c("Unknown", "Other"))
gstotalcaserate <- gstotalcase %>% 
  left_join(gender_tots, by= c("gender" = "gender")) %>% 
  mutate(TotalCaseRate = round((Cases/n)*100000)) %>% 
  select(TotalCaseRate)
  

GenderSummary <- tibble(
  Gender = gstotalcase$gender,
  TotalCases = gstotalcase$Cases,
  ConfirmedCases = gsconfirmedcase$Cases,
  ProbableCases = gsprobcase$Cases,
  TotalDeaths = gstotaldeaths$Deaths,
  ConfirmedDeaths = gsconfdeaths$Deaths,
  ProbableDeaths = gsprobdeaths$Deaths,
  TotalCaseRate = gstotalcaserate$TotalCaseRate,
  DateUpdated = format(graphdate, "%m/%d/%Y")
) 

#### Why is this even here?
# chg_yst2 <- read_csv(paste0("L:/daily_reporting_figures_rdp/yesterday/", Sys.Date() - 1,"/", yesterday_file)) %>%
#   rename(yesterday = `Total**`) 
# chg_yst2[1,1] <- "Total COVID-19 Cases"
# chg_yst2[4,1] <- "Total COVID-19-Associated Deaths"
# chg_yst2 <- chg_yst2 %>% 
#   select(yesterday) %>% 
#   bind_cols(mock_table$`Total**`) %>% 
#   mutate(
#     'Total**' = as.integer("Total**"),
#     sign = ifelse(`Total**`>= yesterday, "+", "-"),
#     delta = abs(`Total**` - yesterday),
#          ) %>% 
#   select(sign, delta)

StateSummary <- tableforgary %>%
  rename(
    Measure ='Overall Summary',
    Total = "Total**",
    Change = 'Change Since Yesterday'
         ) %>% 
  mutate(ChangeDirection = str_extract(Change, pattern = "\\+|\\-"),
         DateUpdated = graphdate,
         Change = str_remove(Change,pattern = "\\+|\\-|%")
         ) %>% 
  select(Measure, Total, ChangeDirection, Change, DateUpdated)%>% 
  replace_na(replace = list(ChangeDirection = ""))
  
#agegroup summary
agstotalcases <- case %>% 
  filter(!is.na(age_group)) %>% 
  group_by(age_group) %>% 
  tally(name = "TotalCases")
agsconfcases <- case %>% 
  filter(!is.na(age_group) & disease_status == "Confirmed") %>% 
  group_by(age_group) %>% 
    tally(name = "ConfCases")

agsprobcases<- case %>% 
  filter(!is.na(age_group) & disease_status == "Probable") %>% 
  group_by(age_group) %>% 
  tally(name = "ProbCases")
agstotaldeaths <- case %>% 
  filter(!is.na(age_group)  & outcome == "Died") %>% 
  group_by(age_group) %>% 
  tally(name = "TotalDeaths") %>% 
  complete(age_group = unique(case$age_group), fill = list("TotalDeaths" = 0))

agsconfdeaths <- case %>% 
  filter(!is.na(age_group) & disease_status == "Confirmed" & outcome == "Died") %>% 
  group_by(age_group) %>% 
  tally(name = "ConfDeaths")%>% 
  complete(age_group = unique(case$age_group), fill = list("ConfDeaths" = 0))

agsprobdeaths <- case %>% 
  filter(!is.na(age_group) & disease_status == "Probable" & outcome == "Died") %>% 
  group_by(age_group) %>% 
  tally(name = "ProbDeaths") %>% 
  complete(age_group = unique(case$age_group), fill = list(ProbDeaths = 0))


agstotalrate <- case %>% 
  filter(!is.na(age_group)) %>% 
  group_by(age_group) %>% 
  tally(name = "TotalCases") %>% 
  left_join(pop, by = c("age_group" = "age_g")) %>% 
  mutate(TotalCaseRate = round((TotalCases/total)*100000))


AgeGroupSummary <- tibble(
  AgeGroups = agstotalcases$age_group,
  TotalCases =agstotalcases$TotalCases,
  ConfirmedCases = agsconfcases$ConfCases,
  ProbableCases = agsprobcases$ProbCases,
  TotalDeaths = agstotaldeaths$TotalDeaths,
  ConfirmedDeaths = agsconfdeaths$ConfDeaths,
  ProbableDeaths = agsprobdeaths$ProbDeaths,
  TotalCaseRate = agstotalrate$TotalCaseRate,
  DateUpdated = graphdate
) %>% 
  mutate(AgeGroups = as.character(AgeGroups))
AgeGroupSummary$AgeGroups[AgeGroupSummary$AgeGroups == ">=80"] <- "80 and older"


###county summary
hospsum <- cha_c %>% filter(!is.na(NAME)) %>%  select(today)
CountySummary <- tbl_cty_sum %>% 
  rename(
    ConfirmedCases = cases.confirmed,
    ProbableCases = cases.probable,
    ConfirmedDeaths = dec.confirmed,
    ProbableDeaths = dec.probable
         ) %>% 
  filter(County != "Pending address validation") %>% 
  bind_cols(county_pop %>% select(-County)) %>%
  mutate(
    TotalCases = ConfirmedCases + ProbableCases,
    TotalDeaths = ConfirmedDeaths + ProbableDeaths,
    CNTY_COD = factor(County, levels =c(
    'Fairfield County','Hartford County','Litchfield County','Middlesex County','New Haven County','New London County', 'Tolland County', 'Windham County'), labels = c(1,2,3,4,5,6,7,8 )),
    CNTY_FIPS = factor(County, levels=c(
    'Fairfield County','Hartford County','Litchfield County','Middlesex County','New Haven County','New London County', 'Tolland County', 'Windham County'), labels=c("'001", "'003", "'005", "'007", "'009", "'011", "'013", "'015")),
    Hospitalization =hospsum$today,
    DateUpdated = graphdate,
    TotalCaseRate = round(TotalCases/Total*100000)
    ) %>% 
  select(CNTY_COD, County, TotalCases, ConfirmedCases,ProbableCases,TotalCaseRate,TotalDeaths,ConfirmedDeaths,ProbableDeaths,Hospitalization,DateUpdated) #CNTY_FIPS removed as of 11/9 per request
  
#deaths by date
totaldeathsdate <- case %>% 
  filter(outcome == "Died") %>% 
  filter(!is.na(death_date) & death_date >="2020-01-01") %>% 
  group_by(death_date) %>% 
  tally(name = "TotalDeathCount") %>% 
  rename(dateofDeath = death_date) %>% 
  complete(dateofDeath = seq.Date(as.Date("2020-01-01"), Sys.Date()-1, by = "day"), fill = list(TotalDeathCount = 0))
confirmeddeathsdate <- case %>% 
  filter(outcome == "Died" & disease_status == "Confirmed") %>% 
  filter(!is.na(death_date) & death_date >="2020-01-01") %>% 
  group_by(death_date) %>% 
  tally(name = "ConfDeathCount") %>% 
  rename(dateofDeath = death_date) %>% 
  complete(dateofDeath = seq.Date(as.Date("2020-01-01"), Sys.Date()-1, by = "day"), fill = list(ConfDeathCount = 0))
probsdeathdate <- case %>% 
  filter(outcome == "Died" & disease_status == "Probable") %>% 
  filter(!is.na(death_date) & death_date >="2020-01-01") %>% 
  group_by(death_date) %>% 
  tally(name = "ProbDeathCount") %>% 
  rename(dateofDeath = death_date) %>% 
  complete(dateofDeath = seq.Date(as.Date("2020-01-01"), Sys.Date()-1, by = "day"), fill = list(ProbDeathCount = 0))

death_by_deathdate <-tibble(
  dateofDeath = totaldeathsdate$dateofDeath,
  TotalDeaths = totaldeathsdate$TotalDeathCount,
  ConfirmedDeaths = confirmeddeathsdate$ConfDeathCount,
  ProbableDeaths = probsdeathdate$ProbDeathCount
)

#count positive, negative, indeterminate, total tests by spec date and county for ODP
agg_tests_spec_date_ag <- elr_linelist %>% 
  filter(test_method %in% agtests)
agg_tests_spec_date_ag$result[agg_tests_spec_date_ag$result == "detected"] <- "Positive"
agg_tests_spec_date_ag$result[agg_tests_spec_date_ag$result == "not detected"] <- "Negative"
agg_tests_spec_date_ag$result[agg_tests_spec_date_ag$result == "indeterminate"] <- "Indeterminate"


agg_tests_spec_date_ag <- agg_tests_spec_date_ag %>%
  group_by(county, spec_col_date, result) %>% 
  tally() %>% 
  replace_na(replace = list(county= "Pending address validation")) %>%
  complete(result = c("Positive", "Negative", "Indeterminate"),fill =  list (n = 0)) %>% 
  pivot_wider(id_cols = c(county, spec_col_date), names_from = result, values_from = n ) %>%
  replace_na(replace = list('Positive' = 0,'Negative'= 0, 'Indeterminate' = 0)) %>%
  mutate(state="CT",
         number_of_ag_tests=sum(Positive, Negative, Indeterminate, na.rm=TRUE)) %>%
  rename(date = spec_col_date,
         number_of_ag_positives = Positive,
         number_of_ag_negatives = Negative,
         number_of_ag_indeterminates = Indeterminate)%>%
    select(county,date,number_of_ag_tests,number_of_ag_positives,number_of_ag_negatives,number_of_ag_indeterminates)

agg_tests_spec_date_pcr <- elr_linelist %>% 
  filter(test_method %in% pcrtests)
agg_tests_spec_date_pcr$result[agg_tests_spec_date_pcr$result == "detected"] <- "Positive"
agg_tests_spec_date_pcr$result[agg_tests_spec_date_pcr$result == "not detected"] <- "Negative"
agg_tests_spec_date_pcr$result[agg_tests_spec_date_pcr$result == "indeterminate"] <- "Indeterminate"

 
agg_tests_spec_date_pcr <- agg_tests_spec_date_pcr %>%
  group_by(county, spec_col_date, result) %>% 
  tally() %>% 
  replace_na(replace = list(county= "Pending address validation")) %>%
  complete(result = c("Positive", "Negative", "Indeterminate"),fill =  list (n = 0)) %>% 
  pivot_wider(id_cols = c(county, spec_col_date), names_from = result, values_from = n ) %>%
  replace_na(replace = list('Positive' = 0,'Negative'= 0, 'Indeterminate' = 0)) %>%
  mutate(state="CT",
         number_of_pcr_tests=sum(Positive, Negative, Indeterminate, na.rm=TRUE)) %>%
  rename(date = spec_col_date,
         number_of_pcr_positives = Positive,
         number_of_pcr_negatives = Negative,
         number_of_pcr_indeterminates = Indeterminate)%>%
    select(county,date,number_of_pcr_tests,number_of_pcr_positives,number_of_pcr_negatives,number_of_pcr_indeterminates)

agg_test_gary <- agg_tests_spec_date_pcr %>%
    left_join(agg_tests_spec_date_ag, by = c('county', 'date')) %>% 
    filter(!is.na(date) & !is.na(county)) 
agg_test_gary[is.na(agg_test_gary)] <- 0


#summary by race/ethnicity
REStateSummary <- race_eth_comb %>% 
  select(-c(caserate100k,deathrate100k)) %>% 
  left_join(adj_table) %>% 
  rename(
    CrudeCaseRate = Crude,
    CaseAgeAdjusted = 'Age adjusted',     
         ) %>% 
  mutate(
    CrudeCaseRate =round(CrudeCaseRate),
    CaseAgeAdjusted = round(CaseAgeAdjusted)
  ) %>% 
  left_join(adj_table_dec) %>% 
  rename(
    CrudeDeathRate = Crude,
    DeathAgeAdjusted = 'Age adjusted',     
         ) %>% 
  mutate(
    CrudeDeathRate =round(CrudeDeathRate ),
    DeathAgeAdjusted= round(DeathAgeAdjusted),
    DateUpdated = graphdate
  ) 


#cases by date by county
countycountDate <- case %>% 
  group_by(date, county) %>% 
  tally(name = "Count") %>% 
  mutate(UpdateDate = Sys.Date()) %>% 
  rename(
    County = county,
    Date = date
         ) %>% 
  ungroup() %>% 
  filter(!is.na(County) & !is.na(Date))


if (csv_write) {
  write_csv(countycountDate, paste0("L:/daily_reporting_figures_rdp/gary_csv/", 
                                    Sys.Date(), "/CountySummarybyDate.csv"))
  write_csv(death_by_deathdate, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/DodSummary.csv"))
  write_csv(GenderSummary, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/GenderSummary.csv"))
  write_csv(StateSummary, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/StateSummary.csv"))
  write_csv(AgeGroupSummary, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/AgeGroupSummary.csv"))
  write_csv(CountySummary, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/CountySummary.csv"))
  write_csv(REStateSummary , paste0("L:/daily_reporting_figures_rdp/gary_csv/", 
                                    Sys.Date(), "/REStateSummary.csv"), na = "")
  write_csv(agg_test_gary, paste0("L:/daily_reporting_figures_rdp/gary_csv/", Sys.Date(), "/TestCounty.csv"))
}
if (SQL_write) {
  df_to_table(countycountDate, "ODP_CountySummarybyDate", overwrite = TRUE, append = FALSE)
  df_to_table(death_by_deathdate, "ODP_DodSummary", overwrite = TRUE, append = FALSE)
  df_to_table(GenderSummary, "ODP_GenderSummary", overwrite = TRUE, append = FALSE)
  df_to_table(StateSummary, "ODP_StateSummary", overwrite = FALSE, append = TRUE)
  df_to_table(AgeGroupSummary, "ODP_AgeGroupSummary", overwrite = TRUE, append = FALSE)
  df_to_table(CountySummary, "ODP_CountySummary", overwrite = TRUE, append = FALSE)
  df_to_table(REStateSummary, "ODP_REStateSummary", overwrite = TRUE, append = FALSE)
  df_to_table(agg_test_gary, "ODP_TestCounty", overwrite = TRUE, append = FALSE)
}

## write_csv(agg_test_cdc,paste0("csv/",Sys.Date(),"/", Sys.Date(), "test.csv"))
```


```{r avg_incidence_gary, eval=wedthurs, message=FALSE, warning=FALSE, include=FALSE}

#calculate % positive by town for past 2 weeks
pctpos14 <- test14nc %>% 
  group_by(city, result) %>% 
  tally() %>%
  pivot_wider(names_from=result, values_from=n) %>% 
  replace_na(replace=list(detected=0, `not detected`=0, indeterminate=0)) %>%
  mutate(PercentPositive = round(detected/(detected+`not detected`)*100, 1),
         TotalTests=detected+`not detected`+indeterminate) %>% 
  select(city, TotalTests,PercentPositive) %>% 
  filter(city != "Not Available")

#community cases in the past 2 weeks with rates by town, case count for each week
gary_dailyincidence <- 
  cases_14_nc %>% 
  group_by(week, city) %>% 
  tally() %>%  
  pivot_wider(names_from = week,  
              values_from = n, 
              values_fill = list(n = 0)) %>% 
  rename(casesweek1 = 2,
         casesweek2 = 3) %>% 
  right_join(c14nc_count, by=c("city" = "NAME")) %>% 
  replace_na(replace=list(casesweek1 = 0, 
                          casesweek2 = 0, 
                          n = 0)) %>% 
  mutate(RateCategory = ifelse(avgrate =="<5 cases per 100,000 or <5 reported cases", 
                               "1. <5 cases per 100,000 or <5 reported cases",
                               ifelse(avgrate=="5-9 cases per 100,000", 
                                      "2. 5-9 cases per 100,000", 
                                      ifelse(avgrate=="10-14 cases per 100,000", 
                                             "3. 10-14 cases per 100,000",
                                             ifelse(avgrate=="15 or more cases per 100,000", 
                                                    "4. 15 or more cases per 100,000", 
                                                    "other")))),
         UpdateDate = Sys.Date(),
         ReportPeriodStartDate = thursday_range_start,
         ReportPeriodEndDate = thursday_range_end,
         townname=paste0(city, " town")) %>%
  rename(totalcases = n,
         NAME = city) %>% 
  left_join(pctpos14, by = c("NAME" = "city")) %>% 
  left_join(town_codes, by = c("townname" = "ANPSADPI")) %>%
  rename(Town_No = TOWNNO) %>% 
  select(Town_No, NAME, pop, casesweek1, casesweek2, totalcases, CaseRate, 
         RateCategory, TotalTests, PercentPositive, UpdateDate, 
         ReportPeriodStartDate, ReportPeriodEndDate) %>%
  filter(!NAME == "Not Available")

### Why do we write the same thing to two different places?

if(csv_write) {
  write_csv(gary_dailyincidence, 
            paste0("L:/daily_reporting_figures_rdp/gary_csv/CTTown_Alert.csv"))
  dir.create(paste0("L:/daily_reporting_figures_rdp/yesterday/", Sys.Date(), "/avg_di"))
  write_csv(gary_dailyincidence, 
            paste0("L:/daily_reporting_figures_rdp/yesterday/", 
                   Sys.Date(),"/avg_di/avgdailyincidence.csv"))
}

```


```{r avg_incidence_gary2, eval=wedthurs, message=FALSE, warning=FALSE, include=FALSE}
lvls <- c("<5 cases per 100,000 or <5 reported cases", "5-9 cases per 100,000", "10-14 cases per 100,000", "15 or more cases per 100,000")
 gdi <- gary_dailyincidence %>%
  mutate(
    RateCategory =str_trim(str_sub(RateCategory, start = 3)),
     RateCategory = factor( RateCategory, labels = lvls, levels = lvls)
         ) %>%
  arrange(desc(RateCategory))

#change for thanksgiving
# change the -7 to the day you need, then make sure the very last table is in that day's folder, It likely won't be, but just go to the very alst thursday and copy it into there and you should be good.
yestgdi <- read_csv(paste0("L:/daily_reporting_figures_rdp/yesterday/", Sys.Date()-7, "/avg_di/avgdailyincidence.csv"))%>%
  mutate(
    RateCategory =str_trim(str_sub(RateCategory, start = 3)),
     RateCategory = factor( RateCategory, labels = lvls, levels = lvls)
         ) %>%
  select(Town_No, RateCategory,CaseRate,TotalTests, PercentPositive) %>%
  rename(
    `Previous Rate Category`=RateCategory,
    `Previous Case Rate`=CaseRate,
   `Previous Test Total`=TotalTests,
    `Previous Percent_Positivity`=PercentPositive
  )


gdi <- gdi %>%
  left_join(yestgdi, by = "Town_No") %>%
  mutate(
    Case_Rate_Difference = CaseRate-`Previous Case Rate`,
    Total_Test_Difference = TotalTests-`Previous Test Total`,
    Percent_Positive_Difference = PercentPositive- `Previous Percent_Positivity`
  )


 gdi2 <- gdi%>%
  select(-c(Town_No, pop, UpdateDate, ReportPeriodStartDate,ReportPeriodEndDate)) %>%
   arrange(desc(RateCategory), desc(CaseRate)) %>% 
   left_join(town_pop18, by = c("NAME" = "city")) %>% 
   mutate(PercentPop = round(pop/3572665*100, 2)) %>% 
   rename(Population=pop)

 kable2 <-  gdi2 %>%
     rename(
       Town = NAME,
       Week1Cases = casesweek1,
       Week2Cases = casesweek2,
       TotalCases = totalcases
            ) %>%
     select(Town, Week1Cases, Week2Cases, TotalCases, CaseRate, RateCategory, TotalTests, PercentPositive, everything()) %>%
    select(-PercentPop) %>% 
    filter(Town != "Not_available")

  #kable2
#  dir.create("tables")
 if(csv_write) {
   dir.create(paste0("L:/daily_reporting_figures_rdp/tables/", Sys.Date()))
   write_csv(kable2, 
             paste0("L:/daily_reporting_figures_rdp/tables/", 
                    Sys.Date(),"/TownAlertLevelsTable.csv"))
 }
 
```

```{r town_alert_summary,  eval=wedthurs, message=FALSE, warning=FALSE, include=FALSE}
towncatthisweek <- gdi2 %>%  group_by(RateCategory) %>%  tally(name = "Towns This Week") %>% 
  mutate(Category= factor(RateCategory, levels = lvls, labels = c("Grey", "Yellow", "Orange", "Red"))) %>% 
  select(-RateCategory)

towncatlastweek <- yestgdi %>%  group_by(`Previous Rate Category`) %>%  tally(name = "Towns Last Week") %>% 
  mutate(Category= factor(`Previous Rate Category`, levels = lvls, labels = c("Grey", "Yellow", "Orange", "Red")))%>% 
  select(-`Previous Rate Category`)
#newtowns
yestred <- yestgdi %>% 
           filter(`Previous Rate Category` == '15 or more cases per 100,000') %>% 
           select(Town_No)
redtownnew <- gdi %>% 
  filter(RateCategory == '15 or more cases per 100,000' & !Town_No %in% yestred$Town_No) %>%
    summarise(
    Category = "Red",
    "New Towns" = nrow(.)
  )

yestorange<- yestgdi %>% 
           filter(`Previous Rate Category` == "10-14 cases per 100,000") %>% 
           select(Town_No)
orangetownnew <- gdi %>% 
  filter(RateCategory == "10-14 cases per 100,000" & !Town_No %in% yestorange$Town_No) %>% 
   summarise(
    Category = "Orange",
    "New Towns" = nrow(.)
  )

yestyellow <- yestgdi %>% 
           filter(`Previous Rate Category` == "5-9 cases per 100,000" ) %>% 
           select(Town_No)
yellowtownnew <- gdi %>% 
  filter(RateCategory == "5-9 cases per 100,000"  & !Town_No %in% yestyellow$Town_No) %>% 
    summarise(
    Category = "Yellow",
    "New Towns" = nrow(.)
  )

yestgrey <- yestgdi %>% 
           filter(`Previous Rate Category` == "<5 cases per 100,000 or <5 reported cases") %>% 
           select(Town_No)
greytownnew <- gdi %>% 
  filter(RateCategory == "<5 cases per 100,000 or <5 reported cases" & !Town_No %in% yestgrey$Town_No) %>% 
  summarise(
    Category = "Grey",
    "New Towns" = nrow(.)
  )
newtowns <- bind_rows(greytownnew, yellowtownnew, orangetownnew, redtownnew)

#lost towns
yestred <- yestgdi %>% 
           filter(`Previous Rate Category` == '15 or more cases per 100,000') %>% 
           select(Town_No)
redtownlost <- gdi %>% 
  filter(RateCategory != '15 or more cases per 100,000' & Town_No %in% yestred$Town_No) %>%
    summarise(
    Category = "Red",
    "Lost Towns" = nrow(.)
  )

yestorange<- yestgdi %>% 
           filter(`Previous Rate Category` == "10-14 cases per 100,000") %>% 
           select(Town_No)
orangetownlost <- gdi %>% 
  filter(RateCategory != "10-14 cases per 100,000" & Town_No %in% yestorange$Town_No) %>% 
   summarise(
    Category = "Orange",
    "Lost Towns" = nrow(.)
  )

yestyellow <- yestgdi %>% 
           filter(`Previous Rate Category` == "5-9 cases per 100,000" ) %>% 
           select(Town_No)
yellowtownlost <- gdi %>% 
  filter(RateCategory != "5-9 cases per 100,000"  & Town_No %in% yestyellow$Town_No) %>% 
    summarise(
    Category = "Yellow",
    "Lost Towns" = nrow(.)
  )

yestgrey <- yestgdi %>% 
           filter(`Previous Rate Category` == "<5 cases per 100,000 or <5 reported cases") %>% 
           select(Town_No)
greytownlost <- gdi %>% 
  filter(RateCategory != "<5 cases per 100,000 or <5 reported cases" & Town_No %in% yestgrey$Town_No) %>% 
  summarise(
    Category = "Grey",
    "Lost Towns" = nrow(.)
  )
losttowns <- bind_rows(greytownlost, yellowtownlost, orangetownlost, redtownlost)


Summary <- towncatthisweek %>% 
  left_join(towncatlastweek) %>% 
  select(Category, `Towns This Week`, `Towns Last Week`, everything()) %>% 
  left_join(newtowns) %>% 
  left_join(losttowns) 

if(csv_write){
  write_csv(Summary, paste0("L:/daily_reporting_figures_rdp/tables/", 
                            Sys.Date(), "/SummaryAlertLevelsTable.csv"))
}

Summary


```




```{r model_data, message=FALSE, warning=FALSE, include=FALSE, eval = thursday}

spec_dates <- case %>% 
  select(spec_col_date) %>% 
  rename(spec_date = spec_col_date) %>% 
  filter(!is.na(spec_date) & spec_date >= "2020-03-01" & spec_date <= Sys.Date()) %>%
  group_by(spec_date) %>% 
  tally(name = "speccollected") %>% 
  complete(spec_date = seq.Date(as.Date(ymd("2020-03-01")), Sys.Date(), by ="day"), fill = list(speccollected = 0))

admissions <- newcha %>% 
  complete(admit_date = seq.Date(as.Date(ymd("2020-03-01")), Sys.Date(), by ="day"), fill = list(admissions = 0))

deathsdata <- case%>% 
  rename(dod= death_date) %>% 
  group_by(dod) %>% 
  tally(name = "deaths") %>%
  filter(!is.na(dod)& dod >= "2020-03-01"  & dod <= Sys.Date()) %>% 
  complete(dod = seq.Date(as.Date(ymd("2020-03-01")), Sys.Date(), by ="day"), fill = list(deaths = 0))

labdata <- elr_linelist %>%
  filter(!is.na(spec_col_date) & spec_col_date >= "2020-03-01"  & spec_col_date <= Sys.Date()) %>%
  group_by(spec_col_date) %>%
  tally(name = "tests") %>%
  complete(spec_col_date = seq.Date(as.Date(ymd("2020-03-01")), Sys.Date(), by ="day"), fill = list(tests = 0))


modelingdata <- bind_cols(spec_dates, admissions, deathsdata, labdata) %>% 
  rename(date = spec_date) %>% 
  mutate(
    spec_cum = cumsum(speccollected),
    admit_cum = cumsum(admissions),
    death_cum = cumsum(deaths),
    test_cum = cumsum(tests)
         ) %>% 
  select(-c(admit_date, dod, spec_col_date))
#dir.create(paste0(path1,"/modeling/"))
#write_csv(modelingdata, paste0(path1,"/modeling/", Sys.Date(), ".csv"))

if(csv_write){
  write_csv(modelingdata, 
            paste0("L:/daily_reporting_figures_rdp/gary_csv/CT_daily_counts_totals.csv"))
}

forrestdata <- testgeo2 %>%
  filter(cong_test!="Yes") %>%
  group_by(spec_col_date, pcrag, result) %>%
  tally()%>%
  pivot_wider(names_from=c("pcrag", "result"), values_from=n)%>%
  replace_na(list(pcr_detected=0, `pcr_not detected`=0, pcr_indeterminate =0, ag_detected=0, `ag_not detected`=0)) %>%
  mutate(pcrtotal = sum(pcr_detected, `pcr_not detected`, pcr_indeterminate, na.rm=TRUE),
         agtotal = sum(ag_detected, `ag_not detected`, na.rm=TRUE))

#create dataset for Forrest

if(csv_write){
  write_csv(forrestdata, 
            paste0("L:/daily_reporting_figures_rdp/csv/", 
                   Sys.Date(), "/", Sys.Date(), "dailytest_communityonly.csv"))
}

#create dataset for sde indicator for county test counts
# added epiyear
sdedata <- testgeo2 %>%
  filter(cong_test !="Yes") %>% 
  mutate(week = epiweek(spec_col_date),
         year = epiyear(spec_col_date),
         result2=ifelse(result=="detected", "Positive",
                        ifelse(result=="not detected", "Negative", "Indeterminate"))) %>% 
  group_by(county, year, week, result2) %>%
  tally() %>% 
  spread(result2, n) %>% 
  replace_na(replace=list(Positive=0, Negative=0, Indeterminate=0)) 

if(csv_write){
  write_csv(sdedata, 
            paste0("L:/daily_reporting_figures_rdp/csv/", 
                   Sys.Date(), "/", Sys.Date(), "communitytest_county.csv"))
}

```


```{r county_data_request, message=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
case_county_cum <-  case %>% 
  group_by(county) %>% 
  tally() %>% 
  filter(!is.na(county) & county != "Unknown") %>% 
  select(-county)
  
c7_logic <- case %>% 
  filter(date %in% seq.Date(Sys.Date()-7, Sys.Date(), by = "day")) 
if(nrow(c7_logic ) >=1){
county7 <- case %>% 
  filter(date %in% seq.Date(Sys.Date()-7, Sys.Date(), by = "day")) %>% 
  group_by(county) %>% 
  tally(name = "n7") %>% 
  filter(!is.na(county) & county != "Unknown") %>% 
  bind_cols(case_county_cum) %>% 
  rename(
    County= county,
    "Cases in last 7 days" =n7,
    "Total cases to date" =n
         )
}else{
county7 <- tibble(
  County = c("Fairfield County", "Hartford County", "Litchfield County", "New Haven County", "Tolland County", "Middlesex County", "New London County","Windham County", NA ),
  "Cases in last 7 days" = 0,
  "Total cases to date" = 0
)  
}

if(csv_write){
  write_csv(county7, 
            paste0("L:/daily_reporting_figures_rdp/csv/", 
                   Sys.Date(), "/", "county7days.csv"))
}

```


```{r town_case_eids,  message=FALSE, warning=FALSE, include=FALSE}
thisweek <-  epiweek(Sys.Date())
townlhd <- read_csv("L:/daily_reporting_figures_rdp/dependancies/towntolhd10_30.csv")

cases <- case %>% 
  # mutate(cong_yn = if_else((str_detect(cong_exposure_type, "Reside")) &
  #                            (str_detect(cong_setting, "Jail / Prison") | str_detect(cong_setting, "Long term care facility") | str_detect(cong_setting, "Assisted Living Facility")),
  #                          "Yes", "No", missing = "No")
  # ) %>% 
  filter(mmwrweek >= thisweek-2 & mmwrweek <= thisweek-1) %>%
  filter(cong_yn == "No") %>% 
  select(eventid, city)
TOI <- unique(town_pop18$city) 
# dir.create("town_case_eventids")
dir.create(paste0("L:/daily_reporting_figures_rdp/town_case_eventids/", Sys.Date()))
mastercase <- cases %>% 
  left_join(townlhd, by = c("city" = "Town")) %>% 
  select(eventid, city, `Health Department Name`) %>% 
  filter(!is.na(city) & !is.na(`Health Department Name`) & city != "Not Available") %>% 
  arrange(`Health Department Name`, city)

if(csv_write){
  write_csv(mastercase, 
            path = paste0("L:/daily_reporting_figures_rdp/town_case_eventids/", 
                          Sys.Date(), "/", "mastereventidlist.csv"))
}

if(csv_write) {
  for(i in TOI){
    casesi <- cases %>%  
      filter(city == i) %>% 
      select(eventid)
    
    dir.create(paste0("L:/daily_reporting_figures_rdp/town_case_eventids/", 
                      Sys.Date(), "/", 
                      townlhd$`Health Department Name`[townlhd$Town == i]))  
    write_csv(casesi, 
              path = paste0("L:/daily_reporting_figures_rdp/town_case_eventids/", 
                            Sys.Date(), "/", 
                            townlhd$`Health Department Name`[townlhd$Town == i] ,
                            "/", i, "last2week.csv"))  
  }
}

```



